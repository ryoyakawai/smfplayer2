<html>
  <head>
    <style>
     .card-wide.mdl-card {
       width: 640px;
     }
     .card-contents {
       margin:20px auto;
     }
     .unvisible {
       visibility: hidden;
       display: none;
     }
     .filelist-div {
       margin:0px 40px;
       padding:10px;
       color:#999999;
       margin:10px;
     }
     .headerline {
       font-size:0.8em;
     }
     .itemline {
       font-size:0.9em;
       line-height: 40px;
       vertical-align: middle;
     }
     .fileicon {
       display: inline-block;
       width:31px;
       user-select: none;
     }
     .fileiconplay {
       margin-left:5px;
       animation-duration: 2s;
       animation-iteration-count: infinite;
     }
     @keyframes kf_fileiconplaying {
       0%   {color: #FFCCBC; /* #cccccc */}
       50%  {color: #FF7043; /* #777777 */}
       100% {color: #FFCCBC;}
     }
    .fileiconnoplay {
       color:#cccccc;
     }
     .filename {
       display: inline-block;
       width:375px;
       margin-left:5px;
       user-select: none;
     }
     .filesize {
       display: inline-block;
       width:165px;
       margin-left:5px;
       user-select: none;
     }
     .bottomline {
       border-bottom:solid 1px #eeeeee;
       padding-bottom:0px;
     }
     .playListItem {
       font-size:1.0em;
       color:#333333;
       margin:0px 0px 0px 0px;
       padding-top:5px;
       transition: 100ms;
     }
    </style>
    <!-- Material Design Lite -->
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <!-- Material Design icon font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  </head>
  <body>
    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <link rel="import" href="bower_components/polymer/polymer.html">
    <link rel="import" href="bower_components/x-webmidi/x-webmidirequestaccess.html">
    <link rel="import" href="components/webmusic-smfreader.html">
    <link rel="import" href="components/webmusic-midiplayback.html">

    <x-webmidirequestaccess sysex output></x-webmidirequestaccess>
    <webmusic-smfreader id="smfreader"></webmusic-smfreader>
    <webmusic-midiplayback id="midiplayback"></webmusic-midiplayback>

    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <header class="mdl-layout__header">
        <div class="mdl-layout__header-row">
          <span class="mdl-layout-title">Standard MIDI File Player 2</span>
        </div>
      </header>

      <main class="mdl-layout__content">
        <div class="page-content">




          <div id="droparea" class="card-wide mdl-card mdl-shadow--2dp card-contents">
            <div class="mdl-card__supporting-text">
              <div>Drop Standard MIDI File Here.</div>
              MIDI Output: <x-webmidioutput id="midioutput" autoreselect></x-webmidioutput><br>
              <button id="play">Play</button>
              <button id="stop">Stop</button>
            </div>
            <div class="mdl-card__actions mdl-card--border"></div>
            <div id="divFileList" class="filelist-div unvisible">
              <div class="bottomline">
                <div class="fileicon"></div>
                <div class="filename headerline">File Name</div>
                <div class="filesize headerline">Size</div>
              </div>
            </div>

          </div>


          

        </div>
      </main>
    </div>

    <div id="message-snackbar" class="mdl-js-snackbar mdl-snackbar">
      <div class="mdl-snackbar__text"></div>
      <button class="mdl-snackbar__action" type="button"></button>
    </div>


    <script type="text/javascript">
     'use strict';

     var AppConst = function() {
         this.listSelectedIdx=null;
     };

     const appConst=new AppConst();
     const midi=document.querySelector("#midioutput");
     const smfReader=document.querySelector("#smfreader");
     const midiPlayback=document.querySelector("#midiplayback");

     // set console.info not to print
     console.info=function(){};

     var droparea=document.querySelector("#droparea");
     droparea.ondragover = smfReader.onDragover;
     droparea.ondragend = droparea.ondragleave = smfReader.dropareaRelease;
     droparea.ondrop = (event) => {
         event.preventDefault();
         smfReader.dropareaRelease(event);
         smfReader.fileOnDrop(event);
     }
     smfReader.addEventListener("raiseError", (event) => {
         console.log("[raiseError]", event.detail);
     });
     smfReader.addEventListener("raiseEvent", (event) => {
         var msg=event.detail;
         switch(msg.type) {
             case "seqAdded":
                 if(document.querySelector("#divFileList").className.match("unvisible")!=null) {
                     document.querySelector("#divFileList").className =
                         document.querySelector("#divFileList").className.replace("unvisible", "");
                 }
                 
                 var div01 = document.createElement("div");
                 div01.className="fileicon itemline fileiconnoplay";
                 div01.innerHTML='<i id="fileicon-'+msg.detail.idx+'" class="material-icons fileiconplay">music_note</i>';
                 var div02 = document.createElement("div");
                 div02.id="child-"+msg.detail.idx;
                 div02.innerHTML=msg.detail.data[msg.detail.idx].name;
                 div02.name=msg.detail.idx;
                 div02.className="fileName itemline";
                 var div03 = document.createElement("div");
                 div03.id="child-"+msg.detail.idx;
                 div03.innerHTML=" "+msg.detail.data[msg.detail.idx].size + " kb";
                 div03.className="filesize itemline";
                 var div00 = document.createElement("div");
                 div00.id="parent-"+msg.detail.idx;
                 div00.className="playlistItem bottomline";
                 div00.appendChild(div01); div00.appendChild(div02); div00.appendChild(div03);

                 div00.addEventListener("mouseover", playListItemMouseOver);
                 div00.addEventListener("mouseout", playListItemMouseOut);
                 div00.addEventListener("mousedown", playListItemMouseDown);

                 document.querySelector("#divFileList").appendChild(div00);
                 break;
         }
         //console.log("[raiseEvent]", msg, option, msg.detail.data[msg.detail.idx].name);
     });

     document.querySelector("#play").addEventListener("mousedown", (evet) => {
         if(midiPlayback.isPlaying()!==true) {
             var selIdx=appConst.listSelectedIdx;
             if(selIdx<0 || selIdx===null) {
                 console.error("Select one from the list.");
                 return;
             } else {
                 var mididata=smfReader.getMidiSeqLists();
                 midiPlayback.setMidiOut(midi.getOutputDevice());
                 midiPlayback.startPlay(mididata[selIdx], 200);
                 document.querySelector("#fileicon-"+selIdx).style.setProperty("animation-name", "kf_fileiconplaying");
                 console.log("MIDI startPlay");
             }
         }
     });
     document.querySelector("#stop").addEventListener("mousedown", (event) => {
         if(midiPlayback.isPlaying()!==false) {
             var selIdx=appConst.listSelectedIdx;
             console.log(selIdx);
             if(selIdx<0 || selIdx===null) {
                 console.error("Select one from the list.");
                 return;
             } else {
                 var eventNo=midiPlayback.stopPlay();
                 var mididata=smfReader.getMidiSeqLists();
                 mididata[0].eventNo=eventNo;
                 document.querySelector("#fileicon-"+selIdx).style.removeProperty("animation-name");
                 console.log("MIDI stopPlay", eventNo);         
             }
         }
     });

     
     // (begin) behavior of item is selected
     const playListItemMouseOver = (event) => {
         var target=checkIsParent(event);
         if(appConst.listSelectedIdx!=target.id.split("-").pop()) {
             target.style.setProperty("background-color", "#eeeeee");
         }
         target.style.setProperty("cursor", "pointer");
     }
     const playListItemMouseOut = (event) => {
         var target=checkIsParent(event);
         if(appConst.listSelectedIdx!=target.id.split("-").pop()) {
             target.style.removeProperty("background-color");
             target.style.removeProperty("cursor");
         }
     }
     const playListItemMouseDown = (event) => {
         var target=checkIsParent(event);
         //var newSelectedIdx=event.target.id.split("-").pop();
         var newSelectedIdx=target.id.split("-").pop();
         if(midiPlayback.isPlaying()!==true) {
             if(appConst.listSelectedIdx!==null
                && newSelectedIdx!=appConst.listSelectedIdx) {
                 var e={target:{id:null}};
                 document.querySelector("#parent-" + appConst.listSelectedIdx).style.removeProperty("background-color");
             }
             target.style.setProperty("background-color", "#f5f5f5");
             appConst.listSelectedIdx=newSelectedIdx;
         } else {
             if(newSelectedIdx!=appConst.listSelectedIdx) {
                 showSnackBar("Stop playback before select another song.");
             }
         }
     }
     const checkIsParent = (event) => {
         var target=event.target;
         if(target.id.match("child")!==null) {
             target=event.target.parentNode;
         }
         return target;
     }
     // (end) behavior of item is selected

     const showSnackBar = (msg) => {
         var snackbarContainer = document.querySelector('#message-snackbar');
         var data = {message: msg};
         snackbarContainer.MaterialSnackbar.showSnackbar(data);   
     }

    </script>

  </body>
</html>
