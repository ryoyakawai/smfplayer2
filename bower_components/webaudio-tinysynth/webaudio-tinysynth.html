<dom-module id="webaudio-tinysynth">
  <template>
  <canvas id="wa-canvas" width="256" height="64" touch-action="none" tabindex="0"></canvas>
  <div id="wa-logo">TinySynth</div>
  <style>
  :host {
    user-select: none;
    display: inline-block;
    position:relative;
    padding:0;
    margin:0;
  }
  #wa-canvas {
    display:block;
    margin:0;
    border:2px solid #666;
    width:256px;
    height:32px;
  }
  #wa-logo{
    position:absolute;
    top:5px;
    left:5px;
    color:#fff;
    font-size:8px;
    background:rgba(0,0,0,0.5);
  }
  </style>
  </template>

  <script>
  Polymer({
    is:"webaudio-tinysynth",
    properties:{
      width:      {type:String, value:"256px", observer:"layout"},
      height:     {type:String, value:"64px", observer:"layout"},
      masterVol:  {type:Number, value:1, observer:"setMasterVol"},
      reverbLev:  {type:Number, value:0.2, observer:"setReverbLev"},
      quality:    {type:Number, value:0, observer:"setQuality"},
      send:        {type:Function, value:this.send},
      setAudioContext:  {type:Function, value:this.setAudioContext},
      graph:      {type:Number, value:2},
      debug:      {type:Number, value:0},
      src:        {type:String, value:null, observer:"loadMIDIUrl"},
      loop:       {type:Number, value:0},
    },
    layout:function(){
      this.$["wa-canvas"].style.width=this.width;
      this.$["wa-canvas"].style.height=this.height;
    },
    program:[
// 1-8 : Piano
      {name:"Acoustic Grand Piano"},    {name:"Bright Acoustic Piano"},
      {name:"Electric Grand Piano"},    {name:"Honky-tonk Piano"},
      {name:"Electric Piano 1"},        {name:"Electric Piano 2"},
      {name:"Harpsichord"},             {name:"Clavi"},
/* 9-16 : Chromatic Perc*/
      {name:"Celesta"},                 {name:"Glockenspiel"},
      {name:"Music Box"},               {name:"Vibraphone"},
      {name:"Marimba"},                 {name:"Xylophone"},
      {name:"Tubular Bells"},           {name:"Dulcimer"},
/* 17-24 : Organ */
      {name:"Drawbar Organ"},           {name:"Percussive Organ"},
      {name:"Rock Organ"},              {name:"Church Organ"},
      {name:"Reed Organ"},              {name:"Accordion"},
      {name:"Harmonica"},               {name:"Tango Accordion"},
/* 25-32 : Guitar */
      {name:"Acoustic Guitar (nylon)"}, {name:"Acoustic Guitar (steel)"},
      {name:"Electric Guitar (jazz)"},  {name:"Electric Guitar (clean)"},
      {name:"Electric Guitar (muted)"}, {name:"Overdriven Guitar"},
      {name:"Distortion Guitar"},       {name:"Guitar harmonics"},
/* 33-40 : Bass */
      {name:"Acoustic Bass"},           {name:"Electric Bass (finger)"},
      {name:"Electric Bass (pick)"},    {name:"Fretless Bass"},
      {name:"Slap Bass 1"},             {name:"Slap Bass 2"},
      {name:"Synth Bass 1"},            {name:"Synth Bass 2"},
/* 41-48 : Strings */
      {name:"Violin"},                  {name:"Viola"},
      {name:"Cello"},                   {name:"Contrabass"},
      {name:"Tremolo Strings"},         {name:"Pizzicato Strings"},
      {name:"Orchestral Harp"},         {name:"Timpani"},
/* 49-56 : Ensamble */
      {name:"String Ensemble 1"},       {name:"String Ensemble 2"},
      {name:"SynthStrings 1"},          {name:"SynthStrings 2"},
      {name:"Choir Aahs"},              {name:"Voice Oohs"},
      {name:"Synth Voice"},             {name:"Orchestra Hit"},
/* 57-64 : Brass */
      {name:"Trumpet"},                 {name:"Trombone"},
      {name:"Tuba"},                    {name:"Muted Trumpet"},
      {name:"French Horn"},             {name:"Brass Section"},
      {name:"SynthBrass 1"},            {name:"SynthBrass 2"},
/* 65-72 : Reed */
      {name:"Soprano Sax"},             {name:"Alto Sax"},
      {name:"Tenor Sax"},               {name:"Baritone Sax"},
      {name:"Oboe"},                    {name:"English Horn"},
      {name:"Bassoon"},                 {name:"Clarinet"},
/* 73-80 : Pipe */
      {name:"Piccolo"},                 {name:"Flute"},
      {name:"Recorder"},                {name:"Pan Flute"},
      {name:"Blown Bottle"},            {name:"Shakuhachi"},
      {name:"Whistle"},                 {name:"Ocarina"},
/* 81-88 : SynthLead */
      {name:"Lead 1 (square)"},         {name:"Lead 2 (sawtooth)"},
      {name:"Lead 3 (calliope)"},       {name:"Lead 4 (chiff)"},
      {name:"Lead 5 (charang)"},        {name:"Lead 6 (voice)"},
      {name:"Lead 7 (fifths)"},         {name:"Lead 8 (bass + lead)"},
/* 89-96 : SynthPad */
      {name:"Pad 1 (new age)"},         {name:"Pad 2 (warm)"},
      {name:"Pad 3 (polysynth)"},       {name:"Pad 4 (choir)"},
      {name:"Pad 5 (bowed)"},           {name:"Pad 6 (metallic)"},
      {name:"Pad 7 (halo)"},            {name:"Pad 8 (sweep)"},
/* 97-104 : FX */
      {name:"FX 1 (rain)"},             {name:"FX 2 (soundtrack)"},
      {name:"FX 3 (crystal)"},          {name:"FX 4 (atmosphere)"},
      {name:"FX 5 (brightness)"},       {name:"FX 6 (goblins)"},
      {name:"FX 7 (echoes)"},           {name:"FX 8 (sci-fi)"},
/* 105-112 : Ethnic */
      {name:"Sitar"},                   {name:"Banjo"},
      {name:"Shamisen"},                {name:"Koto"},
      {name:"Kalimba"},                 {name:"Bag pipe"},
      {name:"Fiddle"},                  {name:"Shanai"},
/* 113-120 : Percussive */
      {name:"Tinkle Bell"},             {name:"Agogo"},
      {name:"Steel Drums"},             {name:"Woodblock"},
      {name:"Taiko Drum"},              {name:"Melodic Tom"},
      {name:"Synth Drum"},              {name:"Reverse Cymbal"},
/* 121-128 : SE */
      {name:"Guitar Fret Noise"},       {name:"Breath Noise"},
      {name:"Seashore"},                {name:"Bird Tweet"},
      {name:"Telephone Ring"},          {name:"Helicopter"},
      {name:"Applause"},                {name:"Gunshot"},
    ],
    drummap:[
// 35
      {name:"Acoustic Bass Drum"},      {name:"Bass Drum 1"},      {name:"Side Stick"},              {name:"Acoustic Snare"},
      {name:"Hand Clap"},               {name:"Electric Snare"},   {name:"Low Floor Tom"},           {name:"Closed Hi Hat"},
      {name:"High Floor Tom"},          {name:"Pedal Hi-Hat"},     {name:"Low Tom"},                 {name:"Open Hi-Hat"},
      {name:"Low-Mid Tom"},             {name:"Hi-Mid Tom"},       {name:"Crash Cymbal 1"},          {name:"High Tom"},
      {name:"Ride Cymbal 1"},           {name:"Chinese Cymbal"},   {name:"Ride Bell"},               {name:"Tambourine"},
      {name:"Splash Cymbal"},           {name:"Cowbell"},          {name:"Crash Cymbal 2"},          {name:"Vibraslap"},
      {name:"Ride Cymbal 2"},           {name:"Hi Bongo"},         {name:"Low Bongo"},               {name:"Mute Hi Conga"},
      {name:"Open Hi Conga"},           {name:"Low Conga"},        {name:"High Timbale"},            {name:"Low Timbale"},
      {name:"High Agogo"},              {name:"Low Agogo"},        {name:"Cabasa"},                  {name:"Maracas"},
      {name:"Short Whistle"},           {name:"Long Whistle"},     {name:"Short Guiro"},             {name:"Long Guiro"},
      {name:"Claves"},                  {name:"Hi Wood Block"},    {name:"Low Wood Block"},          {name:"Mute Cuica"},
      {name:"Open Cuica"},              {name:"Mute Triangle"},    {name:"Open Triangle"},
    ],
    program1:[
      // 1-8 : Piano
      [{w:"sine",d:0.7,r:0.1,},{w:"triangle",v:2.1,d:0.7,s:0.1,g:1,a:0.01,k:-1.2}],
      [{w:"triangle",v:0.4,d:0.7,r:0.1,},{w:"triangle",v:4,t:3,d:0.4,s:0.1,g:1,k:-1,a:0.01,}],
      [{w:"sine",d:0.7,r:0.1,},{w:"triangle",v:4,f:2,d:0.5,s:0.5,g:1,k:-1}],
      [{w:"sine",d:0.7,b:2,},{w:"sawtooth",v:2,t:2,f:2,d:1,g:1,k:-1}],
      [{w:"sine",v:0.4,d:0.7,b:2,},{w:"sine",v:3,t:7,f:1,d:1,s:1,g:1,k:-.7}],
      [{w:"sine",v:0.4,d:0.7,b:2,},{w:"sine",v:11,t:7,f:1,d:0.5,s:1,g:1,k:-.7}],
      [{w:"sawtooth",v:0.4,d:2,},{w:"sine",v:8,f:0.1,d:2,s:1,r:2,g:1,}],
      [{w:"triangle",v:0.4,d:1.5,},{w:"square",v:6,f:0.1,d:1.5,s:0.5,r:2,g:1,}],
      /* 9-16 : Chromatic Perc*/
      [{w:"sine",d:0.3,r:0.3,},{w:"sine",v:7,t:11,d:0.03,g:1,}],
      [{w:"sine",d:0.3,r:0.3,},{w:"sine",v:11,t:6,d:0.2,s:0.4,g:1,}],
      [{w:"sine",v:0.2,d:0.3,r:0.3,},{w:"sine",v:11,t:5,d:0.1,s:0.4,g:1,}],
      [{w:"sine",v:0.2,d:0.6,r:0.6,},{w:"triangle",v:11,t:5,f:1,s:0.5,g:1,}],
      [{w:"sine",v:0.3,d:0.2,r:0.2,},{w:"sine",v:6,t:5,d:0.02,g:1,}],
      [{w:"sine",v:0.3,d:0.2,r:0.2,},{w:"sine",v:7,t:11,d:0.03,g:1,}],
      [{w:"sine",v:0.2,d:1,r:1,},{w:"sine",v:11,t:3.5,d:1,r:1,g:1,}],
      [{w:"triangle",v:0.2,d:0.5,r:0.5,},{w:"sine",v:6,t:2.5,d:0.2,s:0.1,r:0.2,g:1,}],
      /* 17-24 : Organ */
      [{w:"sine",v:0.3,s:0.9,},{w:"sine",v:0.3,t:4,f:2,s:0.9,}],
      [{w:"sine",v:0.3,d:0.05,s:0.9,},{w:"sine",v:33,t:5,f:1.5,d:0.005,s:0.1,g:1,}],
      [{w:"triangle",v:0.3,d:11,},{w:"triangle",v:15,t:3,f:1.5,s:0.2,g:1,}],
      [{w:"sine",v:0.3,a:0.02,s:0.9,},{w:"sine",v:5,t:5,f:1.5,a:0.02,s:0.9,g:1,}],
      [{w:"sine",v:0.2,a:0.02,d:0.05,s:1,},{w:"sine",v:6,t:3,f:1,a:0.02,d:0.05,s:1,g:1,}],
      [{w:"triangle",v:0.2,a:0.02,d:0.05,s:0.8,},{w:"square",v:7,t:3,f:1,d:0.05,s:1.5,g:1,}],
      [{w:"square",v:0.2,a:0.02,d:0.2,s:0.5,},{w:"square",v:1,d:0.03,s:2,g:1,}],
      [{w:"square",v:0.2,a:0.02,d:0.1,s:0.8,},{w:"square",v:1,a:0.3,d:0.1,s:2,g:1,}],
      /* 25-32 : Guitar */
      [{w:"triangle",v:0.3,d:0.5,},{w:"triangle",v:5,t:3,f:1.5,d:1,s:0.1,g:1,}],
      [{w:"triangle",v:0.4,d:0.6,},{w:"triangle",v:8,t:1.001,d:1,s:1,g:1,}],
      [{w:"triangle",v:0.3,d:1,},{w:"triangle",v:6,f:2,d:0.4,s:0.5,g:1,}],
      [{w:"sine",v:0.3,d:1,},{w:"triangle",v:6,f:1,d:0.4,s:0.5,g:1,}],
      [{w:"sine",v:0.4,d:0.1,},{w:"sine",v:7,g:1,}],
      [{w:"triangle",v:0.3,d:1,},{w:"square",v:7,f:2,d:0.3,s:0.5,g:1,}],
      [{w:"triangle",v:0.4,d:1,},{w:"square",v:4,f:2,d:1,s:0.7,g:1,}],
      [{w:"sine",v:0.2,t:1.5,a:0.005,h:0.2,d:0.6,},{w:"sine",v:11,t:5,f:2,d:1,s:0.5,g:1,}],
      /* 33-40 : Bass */
      [{w:"sine",d:0.3,},{w:"sine",v:4,t:3,d:1,s:1,g:1,}],
      [{w:"sine",d:0.3,},{w:"sine",v:4,t:3,d:1,s:1,g:1,}],
      [{w:"sine",d:0.3,},{w:"sine",v:11,t:3,d:0.05,s:0.5,g:1,}],
      [{w:"sine",d:0.3,},{w:"sine",v:4,t:3,d:1,s:1,g:1,}],
      [{w:"triangle",v:0.3,t:2,d:1,},{w:"triangle",v:15,t:2.5,d:0.04,s:0.1,g:1,}],
      [{w:"triangle",v:0.3,t:2,d:1,},{w:"triangle",v:15,t:2.5,d:0.04,s:0.1,g:1,}],
      [{w:"triangle",d:0.7,},{w:"square",v:0.4,t:0.5,f:1,d:0.2,s:10,g:1,}],
      [{w:"triangle",d:0.7,},{w:"square",v:0.4,t:0.5,f:1,d:0.2,s:10,g:1,}],
      /* 41-48 : Strings */
      [{w:"sawtooth",v:0.4,a:0.1,d:11,},{w:"sine",v:5,d:11,s:0.2,g:1,}],
      [{w:"sawtooth",v:0.4,a:0.1,d:11,},{w:"sine",v:5,d:11,s:0.2,g:1,}],
      [{w:"sawtooth",v:0.4,a:0.1,d:11,},{w:"sine",v:5,t:0.5,d:11,s:0.2,g:1,}],
      [{w:"sawtooth",v:0.4,a:0.1,d:11,},{w:"sine",v:5,t:0.5,d:11,s:0.2,g:1,}],
      [{w:"sine",v:0.4,a:0.1,d:11,},{w:"sine",v:6,f:2.5,d:0.05,s:1.1,g:1,}],
      [{w:"sine",v:0.3,d:0.1,r:0.1,},{w:"square",v:4,t:3,d:1,s:0.2,g:1,}],
      [{w:"sine",v:0.3,d:0.5,r:0.5,},{w:"sine",v:7,t:2,f:2,d:1,r:1,g:1,}],
      [{w:"triangle",v:0.6,h:0.03,d:0.1,r:0.1,p:0.8,},{w:"sine",v:4,t:3,d:0.08,r:0.08,p:0.8,g:1,}],
      /* 49-56 : Ensamble */
      [{w:"sawtooth",v:0.3,a:0.03,s:0.5,},{w:"sawtooth",v:0.2,t:2,f:2,d:1,s:2,}],
      [{w:"sawtooth",v:0.3,f:-2,a:0.03,s:0.5,},{w:"sawtooth",v:0.2,t:2,f:2,d:1,s:2,}],
      [{w:"sawtooth",v:0.2,a:0.02,s:1,},{w:"sawtooth",v:0.2,t:2,f:2,a:1,d:1,s:1,}],
      [{w:"sawtooth",v:0.2,a:0.02,s:1,},{w:"sawtooth",v:0.2,f:2,a:0.02,d:1,s:1,}],
      [{w:"triangle",v:0.3,a:0.03,s:1,},{w:"sine",v:3,t:5,f:1,d:1,s:1,g:1,}],
      [{w:"sine",v:0.4,a:0.03,s:0.9,},{w:"sine",v:1,t:2,f:3,d:0.03,s:0.2,g:1,}],
      [{w:"triangle",v:0.6,a:0.05,s:0.5,},{w:"sine",v:1,f:0.8,d:0.2,s:0.2,g:1,}],
      [{w:"square",a:0.01,d:0.2,r:0.005,},{w:"sawtooth",v:0.3,t:1.5,f:1,d:0.2,r:0.1,a:0.01,b:2222,}],
      /* 57-64 : Brass */
      [{w:"square",v:0.3,a:0.01,d:1,s:0.6,r:0.04,},{w:"sine",v:1,d:0.1,s:4,g:1,}],
      [{w:"square",v:0.3,a:0.02,d:1,s:0.5,r:0.08,},{w:"sine",v:1,d:0.1,s:4,g:1,}],
      [{w:"square",v:0.3,a:0.04,d:1,s:0.4,r:0.08,},{w:"sine",v:1,d:0.1,s:4,g:1,}],
      [{w:"square",v:0.2,a:0.04,s:1,},{w:"sine",v:2,d:0.1,g:1,}],
      [{w:"square",v:0.3,a:0.02,d:1,s:0.5,r:0.08,},{w:"sine",v:1,d:0.1,s:4,g:1,}],
      [{w:"square",v:0.3,a:0.02,d:1,s:0.6,r:0.08,},{w:"sine",v:1,f:0.2,d:0.1,s:4,g:1,}],
      [{w:"square",v:0.25,a:0.02,d:0.5,s:0.7,r:0.08,},{w:"sine",v:1,d:0.1,s:4,g:1,}],
      [{w:"square",v:0.3,a:0.02,d:1,s:0.5,r:0.08,},{w:"sine",v:1,d:0.1,s:4,g:1,}],
      /* 65-72 : Reed */
      [{w:"square",v:0.3,a:0.02,d:2,s:0.6,},{w:"sine",v:2,d:1,g:1,}],
      [{w:"square",v:0.3,a:0.02,d:2,s:0.6,},{w:"sine",v:2,d:1,g:1,}],
      [{w:"square",v:0.3,a:0.02,d:1,s:0.6,},{w:"sine",v:2,d:1,g:1,}],
      [{w:"square",v:0.3,a:0.02,d:1,s:0.6,},{w:"sine",v:2,d:1,g:1,}],
      [{w:"sine",v:0.4,a:0.02,d:0.7,s:0.5,},{w:"square",v:5,t:2,d:0.2,s:0.5,g:1,}],
      [{w:"sine",v:0.3,a:0.05,d:0.2,s:0.8,},{w:"sawtooth",v:6,f:0.1,d:0.1,s:0.3,g:1,}],
      [{w:"sine",v:0.3,a:0.03,d:0.2,s:0.4,},{w:"square",v:7,f:0.2,d:1,s:0.1,g:1,}],
      [{w:"square",v:0.3,a:0.05,d:0.1,s:0.8,},{w:"square",v:4,d:0.1,s:1.1,g:1,}],
      /* 73-80 : Pipe */
      [{w:"sine",a:0.02,d:2,},{w:"sine",v:6,t:2,d:0.04,g:1,}],
      [{w:"sine",v:0.7,a:0.03,d:0.4,s:0.4,},{w:"sine",v:4,t:2,f:0.2,d:0.4,g:1,}],
      [{w:"sine",v:0.7,a:0.02,d:0.4,s:0.6,},{w:"sine",v:3,t:2,d:0.05,s:0.1,g:1,}],
      [{w:"sine",v:0.4,a:0.06,d:0.3,s:0.3,},{w:"sine",v:7,t:2,d:0.2,s:0.2,g:1,}],
      [{w:"sine",a:0.02,d:0.3,s:0.3,},{w:"sawtooth",v:3,t:2,d:0.3,g:1,}],
      [{w:"sine",a:0.02,d:2,s:0.1,},{w:"sawtooth",v:8,t:2,f:1,d:0.5,g:1,}],
      [{w:"sine",v:0.7,a:0.03,d:0.5,s:0.3,},{w:"sine",v:0.003,t:0,f:4,d:0.1,s:0.002,g:1,}],
      [{w:"sine",v:0.7,a:0.02,d:2,},{w:"sine",v:1,t:2,f:1,d:0.02,g:1,}],
      /* 81-88 : SynthLead */
      [{w:"square",v:0.3,d:1,s:0.5,},{w:"square",v:1,f:0.2,d:1,s:0.5,g:1,}],
      [{w:"sawtooth",d:2,s:0.5,},{w:"square",v:2,f:0.1,s:0.5,g:1,}],
      [{w:"triangle",a:0.05,d:2,s:0.6,},{w:"sine",v:4,t:2,g:1,}],
      [{w:"triangle",a:0.01,d:2,s:0.3,},{w:"sine",v:22,t:2,f:1,d:0.03,s:0.2,g:1,}],
      [{w:"sawtooth",v:0.4,d:1,s:0.5,},{w:"sine",v:11,t:11,a:0.2,d:0.05,s:0.3,g:1,}],
      [{w:"sine",v:0.4,a:0.06,d:1,s:0.5,},{w:"sine",v:7,f:1,d:1,s:0.2,g:1,}],
      [{w:"sawtooth",v:0.4,a:0.02,d:0.2,s:0.7,r:0.08,},{w:"sawtooth",v:0.3,t:0.75,f:2,a:0.02,d:0.2,s:0.5,r:0.08,}],
      [{w:"triangle",v:0.3,a:0.01,d:11,},{w:"square",v:4,t:0.5,d:0.7,s:0.5,g:1,}],
      /* 89-96 : SynthPad */
      [{w:"triangle",a:0.02,d:0.3,s:0.3,r:0.3,},{w:"square",v:3,t:4,f:1,a:0.02,d:0.1,s:1,g:1,}],
      [{w:"triangle",a:0.05,d:1,s:0.7,r:0.3,},{w:"sawtooth",v:3,t:4,f:1,d:0.3,s:1,g:1,}],
      [{w:"square",v:0.3,a:0.03,d:0.5,s:0.3,r:0.1,},{w:"square",v:4,f:1,a:0.03,d:0.1,g:1,}],
      [{w:"triangle",a:0.08,d:1,s:0.3,r:0.1,},{w:"square",v:3,f:1,d:0.3,s:0.3,g:1,}],
      [{w:"sine",a:0.05,d:1,s:0.3,r:0.1,},{w:"sine",v:0.1,t:2.001,f:1,d:1,s:50,g:1,}],
      [{w:"triangle",a:0.03,d:0.7,s:0.3,r:0.2,},{w:"sine",v:12,t:7,f:1,d:0.5,s:1.7,g:1,}],
      [{w:"sine",a:0.05,d:1,s:0.3,r:0.1,},{w:"sawtooth",v:22,t:6,d:0.06,s:0.3,g:1,}],
      [{w:"triangle",v:0.4,a:0.05,d:11,r:0.3,},{w:"triangle",v:1,d:1,s:8,g:1,}],
      /* 97-104 : FX */
      [{w:"sawtooth",v:0.3,d:4,s:0.8,r:0.1,},{w:"square",v:1,t:2,f:8,a:1,d:1,s:1,r:0.1,g:1,}],
//            [{w:"square",v:0.2,d:0.2,s:1,t:0.8,p:1.25,c:2,},{w:"sawtooth",v:0.2,f:0.5,a:0.01,d:0.2,s:1,t:2.4,p:1.25,b:442,c:1,}],
      [{w:"triangle",v:0.4,d:1,s:0.5,},{w:"triangle",v:11,f:1,a:1,d:0.3,s:1,g:1,}],
      [{w:"sine",v:0.3,d:1,s:0.3,},{w:"square",v:22,t:11,d:0.5,s:0.1,g:1,}],
      [{w:"sawtooth",v:0.3,a:0.04,d:1,s:0.8,r:0.1,},{w:"square",v:1,t:0.5,d:1,s:2,g:1,}],
      [{w:"triangle",v:0.4,d:1,s:0.3,},{w:"sine",v:22,t:6,d:0.6,s:0.05,g:1,}],
      [{w:"sine",v:0.6,a:0.1,d:0.05,s:0.4,},{w:"sine",v:5,t:5,f:1,d:0.05,s:0.3,g:1,}],
      [{w:"sine",a:0.1,d:0.05,s:0.4,},{w:"sine",v:5,t:5,f:1,d:0.05,s:0.3,g:1,}],
      [{w:"square",v:0.3,a:0.1,d:0.1,s:0.4,},{w:"square",v:1,f:1,d:0.3,s:0.1,g:1,}],
      /* 105-112 : Ethnic */
      [{w:"sawtooth",v:0.3,d:0.5,r:0.5,},{w:"sawtooth",v:11,t:5,d:0.05,g:1,}],
      [{w:"square",v:0.3,d:0.2,r:0.2,},{w:"square",v:7,t:3,d:0.05,b:1,g:1,}],
      [{w:"triangle",d:0.2,r:0.2,},{w:"square",v:9,t:3,d:0.1,r:0.1,b:1,g:1,}],
      [{w:"triangle",d:0.3,r:0.3,},{w:"square",v:6,t:3,d:1,r:1,g:1,}],
      [{w:"triangle",v:0.4,d:0.2,r:0.2,},{w:"square",v:22,t:12,d:0.1,r:0.1,g:1,}],
      [{w:"sine",v:0.25,a:0.02,d:0.05,s:0.8,},{w:"square",v:1,t:2,d:0.03,s:11,g:1,}],
      [{w:"sine",v:0.3,a:0.05,d:11,},{w:"square",v:7,t:3,f:1,s:0.7,g:1,}],
      [{w:"square",v:0.3,a:0.05,d:0.1,s:0.8,},{w:"square",v:4,d:0.1,s:1.1,g:1,}],
      /* 113-120 : Percussive */
      [{w:"sine",v:0.4,d:0.3,r:0.3,},{w:"sine",v:7,t:9,d:0.1,r:0.1,g:1,}],
      [{w:"sine",v:0.7,d:0.1,r:0.1,},{w:"sine",v:22,t:7,d:0.05,g:1,}],
      [{w:"sine",v:0.6,d:0.15,r:0.15,b:7,},{w:"square",v:11,t:3.2,d:0.1,r:0.1,g:1,}],
      [{w:"sine",v:0.8,d:0.07,r:0.07,},{w:"square",v:11,t:7,r:0.01,g:1,}],
      [{w:"sine",v:0.7,t:0.5,d:0.2,r:0.2,p:0.95,},{w:"square",v:14,t:2,g:1,}],
      [{w:"sine",v:0.7,d:0.1,r:0.1,p:0.9,},{w:"square",v:14,t:2,d:0.005,r:0.005,g:1,}],
      [{w:"square",d:0.15,r:0.15,p:0.5,},{w:"square",v:4,t:5,d:0.001,r:0.001,g:1,}],
      [{w:"sine",v:0.2,a:1,d:0.001,s:1,r:0.001,b:3532,p:1.2,},{w:"sawtooth",v:0.1,t:0,f:1111,a:1,d:1,s:1,r:0.07,}],
      /* 121-128 : SE */
      [{w:"triangle",t:0,f:1732,d:0.2,r:0.001,b:923,p:1.3,}],
      [{w:"triangle",v:0.2,a:0.05,h:0.02,d:0.02,r:0.02,b:3266,}],
      [{w:"sine",v:0.3,a:1,d:1,b:2305,}],
      [{w:"sine",v:0.3,a:0.01,d:1,s:0.5,},{w:"sawtooth",v:6,t:0,f:12,d:1,s:1,r:0.1,b:14,g:1,}],
      [{w:"square",v:0.3,t:0.25,d:11,s:1,},{w:"square",v:12,t:0,f:8,d:1,s:1,r:11,g:1,}],
      [{w:"sine",v:0.4,t:0,f:500,a:1,d:11,s:1,r:0.5,b:1133,},{w:"square",v:2,t:0,f:14,d:1,s:1,r:11,g:1,}],
      [{w:"triangle",t:0,f:1221,a:0.2,d:11,r:0.5,b:1782,}],
      [{w:"square",d:0.4,r:0.4,p:0.7,},{w:"sine",v:7,t:1.3,d:1,r:1,b:1224,g:1,}],
    ],
    program0:[
// 1-8 : Piano
      [{w:"triangle",v:.5,d:.7}],                   [{w:"triangle",v:.5,d:.7}],
      [{w:"triangle",v:.5,d:.7}],                   [{w:"triangle",v:.5,d:.7}],
      [{w:"triangle",v:.5,d:.7}],                   [{w:"triangle",v:.5,d:.7}],
      [{w:"sawtooth",v:.3,d:.7}],                   [{w:"sawtooth",v:.3,d:.7}],
/* 9-16 : Chromatic Perc*/
      [{w:"sine",v:.5,d:.3,r:.3}],                  [{w:"triangle",v:.5,d:.3,r:.3}],
      [{w:"square",v:.2,d:.3,r:.3}],                [{w:"square",v:.2,d:.3,r:.3}],
      [{w:"sine",v:.5,d:.1,r:.1}],                  [{w:"sine",v:.5,d:.1,r:.1}],
      [{w:"square",v:.2,d:1,r:1}],                  [{w:"sawtooth",v:.3,d:.7,r:.7}],
/* 17-24 : Organ */
      [{w:"sine",v:0.5,a:0.01,s:1}],                [{w:"sine",v:0.7,d:0.02,s:0.7}],
      [{w:"square",v:.2,s:1}],                      [{w:"triangle",v:.5,a:.01,s:1}],
      [{w:"square",v:.2,a:.02,s:1}],                [{w:"square",v:0.2,a:0.02,s:1}],
      [{w:"square",v:0.2,a:0.02,s:1}],              [{w:"square",v:.2,a:.05,s:1}],
/* 25-32 : Guitar */
      [{w:"triangle",v:.5,d:.5}],                   [{w:"square",v:.2,d:.6}],
      [{w:"square",v:.2,d:.6}],                     [{w:"triangle",v:.8,d:.6}],
      [{w:"triangle",v:.4,d:.05}],                  [{w:"square",v:.2,d:1}],
      [{w:"square",v:.2,d:1}],                      [{w:"sine",v:.4,d:.6}],
/* 33-40 : Bass */
      [{w:"triangle",v:.7,d:.4}],                   [{w:"triangle",v:.7,d:.7}],
      [{w:"triangle",v:.7,d:.7}],                   [{w:"triangle",v:.7,d:.7}],
      [{w:"square",v:.3,d:.2}],                     [{w:"square",v:.3,d:.2}],
      [{w:"square",v:.3,d:.1,s:.2}],                [{w:"sawtooth",v:.4,d:.1,s:.2}],
/* 41-48 : Strings */
      [{w:"sawtooth",v:.2,a:.02,s:1}],              [{w:"sawtooth",v:.2,a:.02,s:1}],
      [{w:"sawtooth",v:.2,a:.02,s:1}],              [{w:"sawtooth",v:.2,a:.02,s:1}],
      [{w:"sawtooth",v:.2,a:.02,s:1}],              [{w:"sawtooth",v:.3,d:.1}],
      [{w:"sawtooth",v:.3,d:.5,r:.5}],              [{w:"triangle",v:.6,d:.1,r:.1,h:0.03,p:0.8}],
/* 49-56 : Ensamble */
      [{w:"sawtooth",v:.2,a:.02,s:1}],              [{w:"sawtooth",v:.2,a:.02,s:1}],
      [{w:"sawtooth",v:.2,a:.02,s:1}],              [{w:"sawtooth",v:.2,a:.02,s:1}],
      [{w:"triangle",v:.3,a:.03,s:1}],              [{w:"sine",v:.3,a:.03,s:1}],
      [{w:"triangle",v:.3,a:.05,s:1}],              [{w:"sawtooth",v:.5,a:.01,d:.1}],
/* 57-64 : Brass */
      [{w:"square",v:.3,a:.1,d:.2,s:.6}],           [{w:"square",v:.3,a:.1,d:.2,s:.6}],
      [{w:"square",v:.3,a:.1,d:.2,s:.6}],           [{w:"square",v:0.2,a:0.1,d:0.01,s:1}],
      [{w:"square",v:.3,a:.05,s:1}],                [{w:"square",v:.3,s:.7}],
      [{w:"square",v:.3,s:.7}],                     [{w:"square",v:.3,s:.7}],
/* 65-72 : Reed */
      [{w:"square",v:.3,a:.02,d:2}],                [{w:"square",v:.3,a:.02,d:2}],
      [{w:"square",v:.3,a:.03,d:2}],                [{w:"square",v:.3,a:.04,d:2}],
      [{w:"square",v:.3,a:.02,d:2}],                [{w:"square",v:.3,a:.05,d:2}],
      [{w:"square",v:.3,a:.03,d:2}],                [{w:"square",v:.3,a:.03,d:2}],
/* 73-80 : Pipe */
      [{w:"sine",v:.7,a:.02,d:2}],                  [{w:"sine",v:.7,a:.02,d:2}],
      [{w:"sine",v:.7,a:.02,d:2}],                  [{w:"sine",v:.7,a:.02,d:2}],
      [{w:"sine",v:.7,a:.02,d:2}],                  [{w:"sine",v:.7,a:.02,d:2}],
      [{w:"sine",v:.7,a:.02,d:2}],                  [{w:"sine",v:.7,a:.02,d:2}],
/* 81-88 : SynthLead */
      [{w:"square",v:.3,s:.7}],                     [{w:"sawtooth",v:.4,s:.7}],
      [{w:"triangle",v:.5,s:.7}],                   [{w:"sawtooth",v:.4,s:.7}],
      [{w:"sawtooth",v:.4,d:12}],                   [{w:"sine",v:.4,a:.06,d:12}],
      [{w:"sawtooth",v:.4,d:12}],                   [{w:"sawtooth",v:.4,d:12}],
/* 89-96 : SynthPad */
      [{w:"sawtooth",v:.3,d:12}],                   [{w:"triangle",v:.5,d:12}],
      [{w:"square",v:.3,d:12}],                     [{w:"triangle",v:.5,a:.08,d:11}],
      [{w:"sawtooth",v:.5,a:.05,d:11}],             [{w:"sawtooth",v:.5,d:11}],
      [{w:"triangle",v:.5,d:11}],                   [{w:"triangle",v:.5,d:11}],
/* 97-104 : FX */
      [{w:"triangle",v:.5,d:11}],                   [{w:"triangle",v:.5,d:11}],
      [{w:"square",v:.3,d:11}],                     [{w:"sawtooth",v:0.5,a:0.04,d:11}],
      [{w:"sawtooth",v:.5,d:11}],                   [{w:"triangle",v:.5,a:.8,d:11}],
      [{w:"triangle",v:.5,d:11}],                   [{w:"square",v:.3,d:11}],
/* 105-112 : Ethnic */
      [{w:"sawtooth",v:.3,d:1,r:1}],                [{w:"sawtooth",v:.5,d:.3}],
      [{w:"sawtooth",v:.5,d:.3,r:.3}],              [{w:"sawtooth",v:.5,d:.3,r:.3}],
      [{w:"square",v:.3,d:.2,r:.2}],                [{w:"square",v:.3,a:.02,d:2}],
      [{w:"sawtooth",v:.2,a:.02,d:.7}],             [{w:"triangle",v:.5,d:1}],
/* 113-120 : Percussive */
      [{w:"sawtooth",v:.3,d:.3,r:.3}],              [{w:"sine",v:.8,d:.1,r:.1}],
      [{w:"square",v:.2,d:.1,r:.1,b:7,p:1.05}],     [{w:"sine",v:.8,d:.05,r:.05}],
      [{w:"triangle",v:0.5,d:0.1,r:0.1,b:0,p:0.96}],[{w:"triangle",v:0.5,d:0.1,r:0.1,b:0,p:0.97}],
      [{w:"square",v:.3,d:.1,r:.1,p:.1}],           [{w:"square",v:0.3,a:1,d:0.01,r:0.01,b:3532,p:1.2}],
/* 121-128 : SE */
      [{w:"triangle",v:0.5,d:0.03,t:0,f:1332,r:0.001,b:823,p:1.1}],
      [{w:"triangle",v:0.2,b:3266,d:0.02,a:0.05,h:0.02,r:0.02}],
      [{w:"sine",v:0.3,a:1,b:2305,d:1}],
      [{w:"sine",v:0.3,a:0.8,b:942,d:1,t:0,f:1832}],
      [{w:"triangle",v:0.5,d:0.5,t:0,f:864,b:778}],
      [{w:"sine",v:0.4,d:11,t:0,f:500,b:590}],
      [{w:"triangle",v:0.5,a:0.2,b:1782,d:11,t:0,f:1221}],
      [{w:"triangle",v:0.5,b:2200,d:0.4,r:0.4}],
    ],
    drummap0:[
//35
      [{w:"triangle",f:150,v:0.8,d:0.1,p:0.1,h:0.02,r:0.01,b:0}],
      [{w:"triangle",f:110,v:1,d:.1,h:.02,p:.1,b:1}],
      [{w:"triangle",f:392,v:0.5,d:0.01,p:0,b:2343,t:0,r:0.05}],
      [{w:"triangle",f:322,v:0.5,d:0.05,p:0.2,b:1200,t:0,r:0.05}],
      [{w:"triangle",f:244,v:0.7,d:0.03,b:2231,t:0,r:0.03}],
      [{w:"square",f:310,v:.7,d:.02,p:.1,b:20}],
      [{w:"triangle",f:150,v:.9,d:.1,h:.02,p:.1,b:10}],
      [{w:"square",f:1250,v:0.2,d:0.01,b:8423,r:0.01}],
      [{w:"triangle",f:210,v:.9,d:.1,h:.02,p:.1,b:11}],
      [{w:"square",f:250,v:0.2,d:0.03,b:8423,r:0.03}],
      [{w:"triangle",f:260,v:.9,d:.1,h:.001,p:.1,b:10}],
      [{w:"square",f:1250,v:0.2,d:0.05,b:8423,r:0.01,h:0.02}],
      [{w:"triangle",f:320,v:.9,d:.1,h:.001,p:.1,b:10}],
      [{w:"triangle",f:360,v:.9,d:.1,h:.001,p:.1,b:10}],
      [{w:"square",f:150,v:0.2,d:0.1,b:2823,r:0.01,h:0.05,t:0,p:0.1}],
      [{w:"triangle",f:400,v:.9,d:.1,h:.001,p:.1,b:10}],
      [{w:"square",f:150,v:0.2,d:0.1,b:2823,r:0.01,h:0.05,t:0,p:0.1}],
      [{w:"square",f:150,v:0.2,d:0.1,b:2823,r:0.01,h:0.05,t:0,p:0.1}],
      [{w:"triangle",f:900,v:.3,d:.14,p:.9,b:4000}],
      [{w:"square",f:800,v:0.2,d:0.05,p:0.9,b:700}],
      [{w:"square",f:1200,v:0.3,d:0.12,p:0.9,b:3322,s:0}],
      [{w:"sine",f:600,v:.4,d:.06}],
      [{w:"square",f:150,v:0.2,d:0.1,b:2823,r:0.01,h:0.05,t:0,p:0.1}],
      [{w:"square",f:800,v:0.3,d:0.2,p:0.9,b:844,t:0}],
      [{w:"triangle",f:500,v:.3,d:.14,p:.9,b:4000}],
      [{w:"sine",f:200,v:.5,d:.06}],
      [{w:"sine",f:150,v:.5,d:.06}],
      [{w:"sine",f:300,v:.5,d:.01}],
      [{w:"sine",f:300,v:.5,d:.06}],
      [{w:"sine",f:250,v:.5,d:.06}],
      [{w:"square",f:300,v:.3,d:.06,p:.8,b:23}],
      [{w:"square",f:260,v:.3,d:.06,p:.8,b:43}],
      [{w:"sine",f:850,v:.5,d:.07}],
      [{w:"sine",f:790,v:.5,d:.07}],
      [{w:"sine",f:920,v:.3,a:.05,d:.01,b:1700}],
      [{w:"sawtooth",f:1120,v:.3,a:.05,d:.01,b:2700}],
      [{w:"square",f:1800,v:0.3,d:0.01,p:0.9,b:820,t:0,h:0.03}],
      [{w:"square",f:1800,v:0.3,d:0.01,p:0.9,b:820,t:0,h:0.13}],
      [{w:"sine",f:920,v:.3,a:.02,d:.01,b:1700}],
      [{w:"sine",f:920,v:.3,a:.02,d:.04,b:1700}],
      [{w:"square",f:1450,v:.3,d:.01,b:2400}],
      [{w:"sine",f:650,v:.5,d:.01}],
      [{w:"sine",f:550,v:.5,d:.01}],
      [{w:"square",f:550,v:.3,d:.01,b:300}],
      [{w:"square",f:550,v:0.3,d:0.01,b:300,t:0,h:0.06,r:0.01,p:0.7}],
      [{w:"sine",f:1600,v:.3,d:.01}],
      [{w:"sine",f:1600,v:.3,d:.1}],

    ],
    ready:function(){
      var i;
      this.pg=[]; this.vol=[]; this.ex=[]; this.bend=[]; this.rpnidx=[]; this.brange=[];
      this.sustain=[]; this.notetab=[];
      this.canvas=this.$["wa-canvas"];
      this.ctx=this.canvas.getContext("2d");
      this.ctx.fillStyle="#000";
      this.ctx.fillRect(0,0,256,64);
      if(this.graph){
        setInterval(
          function(){
            if(this.ana){
              var g=new Uint8Array(256);
              this.ana.getByteTimeDomainData(g);
              this.ctx.globalCompositeOperation="lighter";
              this.ctx.fillStyle="#0f0";
              for(var i=0;i<256;++i){
                var v=g[i];
                this.ctx.fillRect(i,((v-128)>>1)+32,1,1);
              }
            }
            this.ctx.globalCompositeOperation="source-over";
            this.ctx.fillStyle="rgba(0,0,0,0.05)";
            this.ctx.fillRect(0,0,256,64);
            if(this.song){
              this.ctx.fillStyle="#036";
              this.ctx.fillRect(180,10,50,45);
              this.ctx.fillStyle="#fff";
              if(this.playing){
                this.ctx.fillRect(190,22,10,20);
                this.ctx.fillRect(210,22,10,20);
              }
              else{
                this.ctx.beginPath();
                this.ctx.moveTo(220,32);
                this.ctx.lineTo(200,42);
                this.ctx.lineTo(200,22);
                this.ctx.fill();
              }
            }
            if(this.playing && this.song.ev.length>0){
              var e=this.song.ev[this.playIndex];
              while(this.actx.currentTime+1>this.playTime){
                if(e.m[0]==0xff51){
                  this.song.tempo=e.m[1];
                  this.tick2Time=4*60/this.song.tempo/this.song.timebase;
                }
                else
                  this.send(e.m,this.playTime);
                ++this.playIndex;
                if(this.playIndex>=this.song.ev.length){
                  if(this.loop){
                    e=this.song.ev[this.playIndex=0];
                    this.playTick=e.t;
                  }
                  else{
                    this.playing=0;
                    break;
                  }
                }
                else{
                  e=this.song.ev[this.playIndex];
                  this.playTime+=(e.t-this.playTick)*this.tick2Time;
                  this.playTick=e.t;
                }
              }
            }
          }.bind(this)
          ,60);
        }
        this.canvas.addEventListener("dragover",this.dragOver.bind(this),false);
        this.canvas.addEventListener("drop",this.drop.bind(this),false);
        this.canvas.addEventListener("click",this.click.bind(this),false);
      },
      setMasterVol:function(){
        if(this.out)
          this.out.gain.value=this.masterVol;
      },
      setReverbLev:function(){
        if(this.rev)
          this.rev.gain.value=this.reverbLev*10;
      },
      click:function(e){
        if(this.playing)
          this.stopMIDI();
        else if(this.song)
          this.playMIDI();
      },
      dragOver:function(e){
        e.stopPropagation();
        e.preventDefault();
        e.dataTransfer.dropEffect = "copy";
      },
      drop:function(e){
        var f = e.dataTransfer.files;
        var reader = new FileReader();
        reader.onload=(e)=>{
          this.loadMIDI(reader.result);
        }
        reader.readAsArrayBuffer(f[0]);
        e.stopPropagation();
        e.preventDefault();
      },
      getTimbreName:function(m,n){
        if(m==0)
          return this.program[n].name;
        else
          return this.drummap[n-35].name;
      },
      loadMIDIUrl:function(url){
        console.log("loadMIDIUrl:"+url);
        if(!url)
          return;
        var xhr=new XMLHttpRequest();
        xhr.open("GET",url,true);
        xhr.responseType="arraybuffer";
        xhr.loadMIDI=this.loadMIDI.bind(this);
        xhr.onload=function(e){
          if(this.status==200){
            this.loadMIDI(this.response);
          }
        };
        xhr.send();
      },
      reset:function(){
        for(var i=0;i<16;++i){
          this.send([0xb0+i,120,0],0);
          this.send([0xb0+i,121,0],0);
        }
      },
      stopMIDI:function(){
        console.log("stopMIDI");
        this.playing=0;
        this.reset();
        this.releaseAllNote();
      },
      playMIDI:function(){
        console.log("playMIDI");
        this.reset();
        this.playTick=0;
        this.playIndex=0;
        this.playTime=this.actx.currentTime+.1;
        this.tick2Time=4*60/this.song.tempo/this.song.timebase;
        this.playing=1;
      },
      loadMIDI:function(data){
        console.log("loadMIDI");
        function Get2(s, i) {
          return (s[i]<<8) + s[i+1];
        }
        function Get3(s, i) {
          return (s[i]<<16) + (s[i+1]<<8) + s[i+2];
        }
        function Get4(s, i) {
          return (s[i]<<24) + (s[i+1]<<16) + (s[i+2]<<8) + s[i+3];
        }
        function GetStr(s, i, len) {
          return String.fromCharCode.apply(null,s.slice(i,i+len));
        }
        function Delta(s, i) {
          var v, d;
          v = 0;
          datalen = 1;
          while((d = s[i]) & 0x80) {
            v = (v<<7) + (d&0x7f);
            ++datalen;
            ++i;
          }
          return (v<<7)+d;
        }
        function Msg(song,tick,s,i){
          var v=s[i];
          datalen=1;
          if((v&0x80)==0)
            v=runst,datalen=0;
          runst=v;
          switch(v&0xf0){
          case 0xc0: case 0xd0:
            song.ev.push({t:tick,m:[v,s[i+datalen]]});
            datalen+=1;
            break;
          case 0xf0:
            switch(v) {
            case 0xff:
              var len = Delta(s, i + 2);
              datastart = 2+datalen;
              datalen = len+datalen+2;
              switch(s[i+1]) {
              case 0x02: song.copyright+=GetStr(s, i + datastart, datalen - 3); break;
              case 0x01: case 0x03: case 0x04: case 0x09:
                song.text=GetStr(s, i + datastart, datalen - datastart);
                break;
              case 0x2f:
                return 1;
              case 0x51:
                var val = Math.floor(60000000 / Get3(s, i + 3));
                song.ev.push({t:tick, m:[0xff51, val]});
                break;
              }
              break;
            }
            break;
          default:
            song.ev.push({t:tick,m:[v,s[i+datalen],s[i+datalen+1]]});
            datalen+=2;
          }
          return 0;
        }
        this.stopMIDI();
        var s=new Uint8Array(data);
        var datalen = 0, datastart = 0, runst = 0x90;
        var idx = 0;
        var hd = s.slice(0,  4);
        if(hd.toString()!="77,84,104,100")  //MThd
          return;
        var len = Get4(s, 4);
        var fmt = Get2(s, 8);
        var numtrk = Get2(s, 10);
        var tickmax=0;
        var tb = Get2(s, 12)*4;
        idx = (len + 8);
        this.song={copyright:"",text:"",tempo:120,timebase:tb,ev:[]};
        for(tr=0;tr<numtrk;++tr){
          hd=s.slice(idx, idx+4);
          len=Get4(s, idx+4);
          if(hd.toString()=="77,84,114,107") {//MTrk
            var tick = 0;
            var j = 0;
            this.notetab.length = 0;
            for(;;) {
              tick += Delta(s, idx + 8 + j);
              j += datalen;
              var e = Msg(this.song, tick, s, idx + 8 + j);
              j += datalen;
              if(e)
                break;
            }
            tick=Math.floor(tick / tb * this.timebase);
            if(tick>tickmax)
              tickmax=tick;
          }
          idx += (len+8);
        }
        this.song.ev.sort(function(x,y){return x.t-y.t});
      },
      setQuality:function(){
        var i,j,p;
        var defp={g:0,w:"sine",t:1,f:0,v:0.5,a:0,h:0.01,d:0.01,s:0,r:0.05,p:1,b:0,c:2,k:0};
        function filldef(p){
          for(var n=0;n<p.length;++n){
            for(var k in defp){
              if(!p[n].hasOwnProperty(k) || typeof(p[n][k])=="undefined"){
                p[n][k]=defp[k];
              }
            }
          }
        }
        for(i=0;i<128;++i)
          this.program[i].p=this.program0[i];
        for(i=0;i<this.drummap0.length;++i)
          this.drummap[i].p=this.drummap0[i];
        if(this.quality){
          for(i=0;i<this.program1.length;++i)
            this.program[i].p=this.program1[i];
        }
        for(i=0;i<128;++i)
          filldef(this.program[i].p);
        for(i=0;i<this.drummap.length;++i)
          filldef(this.drummap[i].p);
      },
      note:function(t,ch,n,v,p){  /* note trigger */
        var o=[],g=[],vp=[],r=[];
        var f=440*Math.pow(2,(n-69)/12);
        var i,out,sc;
        for(i=0;i<p.length;++i){
          o[i]=this.actx.createOscillator();
          g[i]=this.actx.createGain();
        }
        for(i=0;i<p.length;++i){
          pn=p[i];
          r[i]=pn.r;
          if(pn.g==0){
            out=this.chvol[ch];
            sc=v/127;
          }
          else
            out=o[i-1].frequency;
          var dt=t+pn.a+pn.h;
          o[i].type=pn.w;
          o[i].detune.value=this.bend[ch];
          o[i].frequency.value=(f=f*pn.t+pn.f);
          o[i].connect(g[i]); g[i].connect(out);
          if(pn.k){
            vp[i]=sc*pn.v*Math.pow(2,(n-60)/12*pn.k);
          }
          else
            vp[i]=sc*pn.v;
          if(pn.a){
            g[i].gain.setValueAtTime(0,t);
            g[i].gain.linearRampToValueAtTime(vp[i],t+pn.a);
          }
          else
            g[i].gain.setValueAtTime(vp[i],t);
          sc=f;
          o[i].start(t);
          g[i].gain.setTargetAtTime(pn.s*vp[i],dt,pn.d);
          if(pn.b){
            var g3=this.actx.createGain();
            o[i].connect(g3);
            g3.gain.setValueAtTime(pn.b,t);
            g3.connect(o[i].frequency);
          }
          if(pn.p!=1)
            o[i].frequency.setTargetAtTime(f*pn.p,dt,pn.d);
          if(n<0){
            var t2=dt+pn.d*10;
            o[i].stop(t2);
          }
        }
        if(n>=0)
          this.notetab.push({t:t,e:99999,ch:ch,n:n,o:o,g:g,t2:t,v:vp,r:r,f:0});
      },
      releaseAllNote(){
        t=this.actx.currentTime+.1;
        for(var i=this.notetab.length-1;i>=0;--i){
          var nt=this.notetab[i];
          for(var k=nt.g.length-1;k>=0;--k){
            nt.g[k].gain.cancelScheduledValues(t);
            nt.g[k].gain.setValueAtTime(0,t);
          }
          nt.f=1;
          nt.e=t;
        }
      },
      releaseNote(nt,t){
        for(var k=nt.g.length-1;k>=0;--k){
          nt.g[k].gain.cancelScheduledValues(t);
          if(t<=nt.t2){
            if(t==nt.t2)
              nt.g[k].gain.setValueAtTime(nt.v[k],t);
            else
              nt.g[k].gain.setValueAtTime(nt.v[k]*(t-nt.t)/(nt.t2-nt.t),t);
          }
          nt.g[k].gain.setTargetAtTime(0,t,nt.r[k]);
        }
        nt.e=t+nt.r[0]*10;
        nt.f=1;
      },
      sustainState(ch,v,t){
        this.sustain[ch]=v;
        if(v<64){
          for(var i=this.notetab.length-1;i>=0;--i){
            var nt=this.notetab[i];
            if(t>=nt.t && nt.ch==ch && nt.f==1){
              this.releaseNote(nt,t);
            }
          }
        }
      },
      resetAllController(ch){
        this.bend[ch]=0; this.vol[ch]=100; this.ex[ch]=64;
        this.brange[ch]=2<<7; this.rpnidx[ch]=0x3fff; this.sustain[ch]=0;
        this.chvol[ch].gain.value=this.vol[ch]*this.ex[ch]*3/16384;
      },
      send:function(msg,t,tr){    /* send midi message */
        var i;
        var ch=msg[0]&0xf;
        var cmd=msg[0]&~0xf;
        var n=msg[1],v=msg[2];
        if(cmd<0x80||cmd>=0x100)
          return;
        if(cmd==0x90 && v==0)
          cmd=0x80;
        if(!t){
          if(this.actx)
            t=this.actx.currentTime;
          else
            t=0;
        }
        switch(cmd){
        case 0xb0:  /* ctl change */
          if(this.debug)
            console.log("CTL("+ch+")="+n+","+v);
          switch(n){
          case 7: /* ch vol */
            this.chvol[ch].gain.setValueAtTime((this.vol[ch]=v)*this.ex[ch]*3/16384,t);
            break;
          case 11: /* expression */
            this.chvol[ch].gain.setValueAtTime(this.vol[ch]*(this.ex[ch]=v)*3/16384,t);
            break;
          case 64:
            this.sustainState(ch,v,t);
            break;
          case 98:  /* nrpn lsb */
          case 99:  /* nrpn msb */
            this.rpnidx[ch]=0x3fff;
            break;
          case 100: /* rpn lsb */
            this.rpnidx[ch]=(this.rpnidx[ch]&0x380)|v;
            break;
          case 101: /* rpn msb */
            this.rpnidx[ch]=(this.rpnidx[ch]&0x7f)|(v<<7);
            break;
          case 6:  /* data entry msb */
            if(this.rpnidx[ch]==0){
              this.brange[ch]=(v<<7)+(this.brange[ch]&0x7f);
            }
            break;
          case 38:  /* data entry lsb */
            if(this.rpnidx[ch]==0){
              this.brange[ch]=(this.brange[ch]&0x380)|v;
              if(this.debug)
                console.log("BRANGE("+ch+")="+(this.brange[ch]>>7)+","+(this.brange[ch]&0x7f));
            }
            break;
          case 120:  /* all sound off */
          case 123:  /* all notes off */
            for(var i=this.notetab.length-1;i>=0;--i){
              var nt=this.notetab[i];
              for(var i=nt.g.length-1;i>=0;--i){
                nt.g[i].gain.cancelScheduledValues(t);
                nt.g[i].gain.setTargetAtTime(0,t,0.05);
              }
              for(var i=nt.o.length-1;i>=0;--i){
                nt.o[i].stop(t+0.5);
              }
              nt.e=t+0.5;
              this.notetab.splice(i,1);
            }
            break;
          case 121:  /* reset all controller */
            for(var i=0;i<16;++i){
              this.resetAllController(i);
            }
            break;
          }
          break;
        case 0xc0:  /* prg change */
          this.pg[ch]=n;
          if(this.debug)
            console.log("PRG:"+ch+","+(n+1));
          break;
        case 0xe0:  /* pitch bend */
          var br=this.brange[ch]*100/127;
          this.bend[ch]=(n+(v<<7)-8192)*br/8192;
          for(var i=this.notetab.length-1;i>=0;--i){
            var nt=this.notetab[i];
            if(nt.ch==ch){
              for(var k=nt.o.length-1;k>=0;--k)
                nt.o[k].detune.setValueAtTime(this.bend[ch],t);
            }
          }
          break;
        case 0x90:  /* note on */
          this.ctx.fillStyle="#f00";
          this.ctx.globalCompositeOperation="lighter";
          this.ctx.fillRect(240,62-ch*4,10,3);
          if(this.debug)
            console.log("NOTEON("+ch+")="+n+","+v+","+t);
          if(ch==9){
            if(n>=35&&n<=81){
              this.note(t,ch,-1,v,this.drummap[n-35].p);
            }
            return;
          }
          this.note(t,ch,n,v,this.program[this.pg[ch]].p);
          break;
        case 0x80:  /* note off */
          if(this.debug)
            console.log("NOTEOFF("+ch+")="+n+","+v+","+t);
          for(var i=this.notetab.length-1;i>=0;--i){
            var nt=this.notetab[i];
            if(t>nt.e){
              for(var k=nt.o.length-1;k>=0;--k)
                nt.o[k].stop(nt.e);
              this.notetab.splice(i,1);
            }
            else if(t>=nt.t && nt.ch==ch && nt.n==n && nt.f==0){
              nt.f=1;
              if(this.sustain[ch]<64)
                this.releaseNote(nt,t);
            }
          }
          break;
        }
      },
      setAudioContext:function(actx,dest){
        var i;
        this.actx=actx;
        this.dest=dest;
        if(!dest)
          this.dest=actx.destination;
        this.conv=this.actx.createConvolver();
        this.rev=this.actx.createGain();
        this.comp=this.actx.createDynamicsCompressor();
        this.rev.gain.value=this.reverbLev;
        this.out=this.actx.createGain();
        this.out.gain.value=.3;
        this.out.connect(this.conv);
        this.out.connect(this.comp);
        this.conv.connect(this.rev);
        this.rev.connect(this.comp);
        this.comp.connect(this.dest);
        var blen=this.actx.sampleRate*.5|0;
        this.convBuf=this.actx.createBuffer(1,blen,this.actx.sampleRate);
        var d=this.convBuf.getChannelData(0);
        for(i=0;i<blen;++i)
          d[i]=Math.exp(-3*i/blen)*(Math.random()-.5);
        this.conv.buffer=this.convBuf;
        this.chvol=[];
        for(i=0;i<16;++i){
          this.chvol[i]=this.actx.createGain();
          this.chvol[i].connect(this.out);
          this.pg[i]=i;
          this.resetAllController(i);
        }
        if(this.graph>=2){
          this.ana=this.actx.createAnalyser();
          this.out.connect(this.ana);
        }
        this.setReverbLev();
      },
      redraw:function(){
      }
    });
  </script>
</dom-module>
