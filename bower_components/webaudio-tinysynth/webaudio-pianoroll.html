<dom-module id="webaudio-pianoroll">
	<template>
		<div class="wac-body" id="wac-body" touch-action="none">
			<canvas id="wac-pianoroll" touch-action="none" tabindex="0"></canvas>
			<div id="wac-kb"></div>
			<img id="wac-markstart" class="marker" src="{{markstartsrc}}"/>
			<img id="wac-markend" class="marker" src="{{markendsrc}}"/>
			<img id="wac-cursor" class="marker" src="{{cursorsrc}}"/>
			<div id="wac-menu">Delete</div>
		</div>
		<style>
			:host {
				user-select: none;
				display: inline-block;
				font-family: sans-serif;
				font-size: 11px;
				padding:0;
				margin:0;
			}
			#wac-body {
				position: relative;
				margin:0;
				padding:0;
				width: 100%;
				height: 100%;
				overflow: hidden;
			}
			#wac-pianoroll {
				cursor: pointer;
				margin:0;
				padding:0;
				width: 100%;
				height: 100%;
				background-size:100% calc(100%*12/16);
				background-position:left bottom;
			}
			#wac-menu {
				display:none;
				position:absolute;
				top:0px;
				left:0px;
				background:#eef;
				color:#000;
				padding:2px 10px;
				border:1px solid #66f;
				border-radius: 4px;
				cursor:pointer;
			}
			.marker{
				position: absolute;
				left:0px;
				top:0px;
				cursor:ew-resize;
			}
			#wac-kb{
				position:absolute;
				left:0px;
				top:0px;
				width:100px;
				height:100%;
				background: repeat-y;
				background-size:100% calc(100%*12/16);
				background-position:left bottom;
			}
		</style>
	</template>

	<script>
		Polymer({
			is:"webaudio-pianoroll",
			properties:{
				width:      {type:Number, value:640, observer:'layout'},
				height:     {type:Number, value:320, observer:'layout'},
				timebase:		{type:Number, value:16},
				editmode:		{type:String, value:"gridmono"},
				xrange:			{type:Number, value:16, observer:'layout'},
				yrange:			{type:Number, value:16, observer:'layout'},
				xoffset:		{type:Number, value:0, observer:'layout'},
				yoffset:		{type:Number, value:60, observer:'layout'},
				grid:				{type:String, value:"1,16"},
				snap:				{type:Number, value:4},
				wheelzoom:	{type:Number, value:0},
				xruler:			{type:Number, value:24, observer:'layout'},
				yruler:			{type:Number, value:24, observer:'layout'},
				octadj:			{type:Number, value:-1},
				cursor:			{type:Number, value:0, observer:'redrawMarker'},
				markstart:	{type:Number, value:0, observer:'redrawMarker'},
				markend:		{type:Number, value:16, observer:'redrawMarker'},
				defvelo:		{type:Number, value:100},
				collt:			{type:String, value:"#ccc"},
				coldk:			{type:String, value:"#aaa"},
				colgrid:		{type:String, value:"#666"},
				colnote:		{type:String, value:"#f22"},
				colnotesel:	{type:String, value:"#0f0"},
				colnoteborder:	{type:String, value:"#000"},
				colnoteselborder:	{type:String, value:"#fff"},
				colrulerbg:	{type:String, value:"#666"},
				colrulerfg:	{type:String, value:"#fff"},
				colrulerborder:	{type:String, value:"#000"},
				colselarea: {type:String, value:"rgba(0,0,0,0.3)"},
				bgsrc:			{type:String, value:null, observer:'layout'},
				cursorsrc: {type:String, value:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIj4NCjxwYXRoIGZpbGw9InJnYmEoMjU1LDEwMCwxMDAsMC44KSIgZD0iTTAsMSAyNCwxMiAwLDIzIHoiLz4NCjwvc3ZnPg0K"},
				cursoroffset:{type:Number, value:0},
				markstartsrc: {type:String, value:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4NCjxwYXRoIGZpbGw9IiMwYzAiIGQ9Ik0wLDEgMjQsMSAwLDIzIHoiLz4NCjwvc3ZnPg0K"},
				markstartoffset:{type:Number, value:0},
				markendsrc: {type:String, value:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4NCjxwYXRoIGZpbGw9IiMwYzAiIGQ9Ik0wLDEgMjQsMSAyNCwyMyB6Ii8+DQo8L3N2Zz4NCg=="},
				markendoffset:{type:Number, value:-24},
				kbsrc:{type:String, value:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSI0ODAiPg0KPHBhdGggZmlsbD0iI2ZmZiIgc3Ryb2tlPSIjMDAwIiBkPSJNMCwwIGgyNHY0ODBoLTI0eiIvPg0KPHBhdGggZmlsbD0iIzAwMCIgZD0iTTAsNDAgaDEydjQwaC0xMnogTTAsMTIwIGgxMnY0MGgtMTJ6IE0wLDIwMCBoMTJ2NDBoLTEyeiBNMCwzMjAgaDEydjQwaC0xMnogTTAsNDAwIGgxMnY0MGgtMTJ6Ii8+DQo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAiIGQ9Ik0wLDYwIGgyNCBNMCwxNDAgaDI0IE0wLDIyMCBoMjQgTTAsMjgwIGgyNCBNMCwzNDAgaDI0IE0wLDQyMCBoMjQiLz4NCjwvc3ZnPg0K", observer:'layout'},
				kbwidth:{type:Number,value:40},
				loop:				{type:Number, value:0},
				preload:		{type:Number, value:1.0},
				tempo:			{type:Number, value:120},
				curtrack:		{type:Number, value:0, observer:'redraw'},
				enable:			{type:Boolean, value:true},
				option:			{type:Number, value:0},
			},
			sortSequence:function(tr){
				if(typeof(tr)=="undefined")
					tr=this.curtrack;
				this.track[tr].ev.sort((x,y)=>{return x.t-y.t;});
			},
			play:function(actx,playcallback,tick){
				this.locate=function(tick){
					var tr,trmax=this.track.length;
					for(tr=0;tr<trmax;++tr){

					}
				};
				this.nextev=function(track,trmax,idx){
					var mn,mntr,tr;
					for(mn=99999999,mntr=-1,tr=0;tr<trmax;++tr){
						var e=track[tr].ev[idx[tr]];
						if(e && e.t<mn){
							mn=e.t,mntr=tr;
						}
					}
					if(mntr<0)
						return [-1,this.markend];
					return [mntr,mn];
				};
				this.interval=function(){
					var i,l;
					var current=actx.currentTime;
					var callbackque=[];
					var cpstop=this.curposstack[0];
					if(cpstop&&current>cpstop[0]){
						this.cursor=this.cursor0=cpstop[1];
						this.cursortime=cpstop[0];
						this.curposstack.shift();
					}
					this.cursor=this.cursor0+(current-this.cursortime)/this.tick2time;
					while(current+1>=this.nextTime){
						var tr=this.next[0];
						if(this.next[0]<0){
							if(this.loop){
								for(tr=0;tr<trmax;++tr){
									this.idx[tr]=0;
									callbackque.push([[0xb0+this.track[tr].ch,121,0],this.nextTime,this.nextTime,tr]);
								}
								this.curTick=0;
								this.curposstack.push([this.nextTime,this.markstart]);
								this.next=this.nextev(this.track,trmax,this.idx);
								this.nextTime+=(this.next[1]-this.markstart)*this.tick2time;
								if(this.next[0]>=0)
									this.curposstack.push([this.nextTime,this.next[1]]);
							}
							else
								clearInterval(this.timer);
							return;
						}
						var e=this.track[tr].ev[this.idx[tr]];
						if(e){
							var gmax=e.g;
							var c=e.c;
							if(c<0xff00)
								c+=this.track[tr].ch;
							switch(e.c){
							case 0xff51:
								this.setTempo(e.v);
								break;
							case 0x90:
								this.notetab.push([this.nextTime,this.nextTime+gmax*this.tick2time,this.track[tr].ch,e.n,tr]);
								callbackque.push([[c,e.n,e.v],this.nextTime,this.nextTime,tr]);
								break;
							case 0xb0:
								callbackque.push([[c,e.n,e.v],this.nextTime,this.nextTime,tr]);
								break;
							case 0xc0:
								callbackque.push([[c,e.v],this.nextTime,this.nextTime,tr]);
								break;
							case 0xe0:
								var b=e.v+8192;
								callbackque.push([[c,b&0x7f,(b>>7)&0x7f],this.nextTime,this.nextTime,tr]);
								break;
							}
						}
						if(this.next[0]>=0)
							++this.idx[this.next[0]];
						this.curTick=this.next[1];
						this.next=this.nextev(this.track,trmax,this.idx);
						this.nextTime+=(this.next[1]-this.curTick)*this.tick2time;
						if(this.next[0]>=0)
							this.curposstack.push([this.nextTime,this.next[1]]);
						else
							this.curposstack.push([this.nextTime,this.markend]);
					}
					for(i=0,l=this.notetab.length;i<l;++i){
						var e=this.notetab[i];
						if(!e)
							break;
						if(current+1>=e[1]){
							callbackque.push([[0x80+e[2],e[3],0],e[1],e[0],e[4]]);
							this.notetab.splice(i,1);
							--i;
						}
					}
					callbackque.sort(function(x,y){if(x[1]!=y[1]) return x[1]-y[1]; else  return x[2]-y[2];});
					for(var i=0,l=callbackque.length;i<l;++i){
						if(this.playcallback)
							this.playcallback(callbackque[i][0],callbackque[i][1],callbackque[i][3]);
					}
				}
				this.playcallback=playcallback;
				this.actx=actx;
				this.cursortime=this.nextTime=actx.currentTime+.1;
				this.curTick=0;
				this.cursor0=this.cursor;
				this.startTick=this.cursor;
				this.startTime=this.nextTime;
				var trmax=this.track.length;
				var tr,i,mn;
				this.idx=[];
				this.notetab=[];
				this.curposstack=[];
				this.curposdelta=0;
				this.tick2time=4*60/this.tempo/this.timebase;
				for(tr=0;tr<trmax;++tr){
					this.idx[tr]=0;
					if(this.playcallback)
						this.playcallback([0xb0+this.track[tr].ch,121,0],this.actx.currentTime,-1);
				}
				this.curposstack.push([this.nextTime,this.curTick]);
				this.next=this.nextev(this.track,trmax,this.idx);
				this.nextTime+=(this.next[1]-this.curTick)*this.tick2time;
				this.curposstack.push([this.nextTime,this.next[1]]);
				this.timer=setInterval(this.interval.bind(this),10);
			},
			stop:function(){
				for(i=0,l=this.notetab.length;i<l;++i){
					var e=this.notetab[i];
					if(this.playcallback)
						this.playcallback([0x80+e[2],e[3],0],e[1]+0.001,-1);
				}
				if(this.timer)
					clearInterval(this.timer);
				this.timer=null;
			},
			setMMLString:function(s){
				this.track=[{ev:[],ch:0,name:""}];
				this.curtrack=0;
				var i,l,n,t,defo,defl,tie,evlast;
				var parse={s:s,i:i,tb:this.timebase};
				function getNum(p){
					var n=0;
					while(p.s[p.i]>="0"&&p.s[p.i]<="9"){
						n=n*10+parseInt(p.s[p.i]);
						++p.i;
					}
					return n;
				}
				function getLen(p){
					var n=getNum(p);
					if(n==0)
						n=defl;
					n=p.tb/n;
					var n2=n;
					while(p.s[p.i]=="."){
						++p.i;
						n+=(n2>>=1);
					}
					return n;
				}
				function getNote(p){
					switch(p.s[p.i]){
					case "c": case "C": n=0; break;
					case "d": case "D": n=2; break;
					case "e": case "E": n=4; break;
					case "f": case "F": n=5; break;
					case "g": case "G": n=7; break;
					case "a": case "A": n=9; break;
					case "b": case "B": n=11; break;
					default:
						n=-1;
					}
					++p.i;
					if(n<0)
						return -1;
					for(;;){
						switch(p.s[p.i]){
						case "-": --n; break;
						case "+": ++n; break;
						case "#": ++n; break;
						default:
							return n;
						}
						++p.i;
					}
				}
				defo=4;
				defl=8;
				t=0;
				tie=0;
				evlast=null;
				for(parse.i=0;parse.i<parse.s.length;){
					switch(parse.s[parse.i]){
					case '>':
						++parse.i; ++defo; n=-1; l=0;
						break;
					case '<':
						++parse.i; --defo; n=-1; l=0;
						break;
					case '&': case '^':
						++parse.i; tie=1; n=-1; l=0;
						break;
					case 't': case 'T':
						++parse.i; n=-1; l=0;
						this.tempo=getNum(parse);
						break;
					case 'o': case 'O':
						++parse.i; n=-1; l=0;
						defo=getNum(parse);
						break;
					case 'l': case 'L':
						++parse.i; n=-1; l=0;
						defl=getNum(parse);
						break;
					case 'r': case 'R':
						++parse.i; n=-1;
						l=getLen(parse);
						break;
					default:
						n=getNote(parse);
						if(n>=0)
							l=getLen(parse);
						else
							l=0;
						break;
					}
					if(n>=0){
						n=(defo-this.octadj)*12+n;
						if(tie && evlast && evlast.n==n){
							evlast.g+=l;
							tie=0;
						}
						else
							this.track[this.curtrack].ev.push(evlast={t:t,c:0x90,n:n,g:l,f:0,v:this.defvelo});
					}
					t+=l;
				}
				this.redraw();
			},
			getMMLString:function(){
				function makeNote(n,l,tb){
					var mmlnote="";
					var ltab=[
						[960,"1"],[840,"2.."],[720,"2."],[480,"2"],
						[420,"4.."],[360,"4."],[240,"4"],
						[210,"8.."],[180,"8."],[120,""],
						[105,"16.."],[90,"16."],[60,"16"],
						[45,"32."],[30,"32"],[16,"60"],[15,"64"],
						[8,"120"],[4,"240"],[2,"480"],[1,"960"]
					];
					l=l*960/tb;
					while(l>0){
						for(var j=0;j<ltab.length;++j){
							while(l>=ltab[j][0]){
								l-=ltab[j][0];
								mmlnote+="&"+n+ltab[j][1];
							}
						}
					}
					return mmlnote.substring(1);
				}
				var mml="t"+this.tempo+"o4l8";
				var ti=0,meas=0,oct=5,n;
				var notes=["c","d-","d","e-","e","f","g-","g","a-","a","b-","b"];
				for(var i=0;i<this.track[this.curtrack].ev.length;++i) {
					var ev=this.track[this.curtrack].ev[i];
					if(ev.t>ti) {
						var l=ev.t-ti;
						mml+=makeNote("r",l,this.timebase);
						ti=ev.t;
					}
					var n=ev.n;
					if(n<oct*12||n>=oct*12+12){
						oct=(n/12)|0;
						mml+="o"+(oct+this.octadj);
					}
					n=notes[n%12];
					var l=ev.g;
					if(i+1<this.track[this.curtrack].ev.length) {
						var ev2=this.track[this.curtrack].ev[i+1];
						if(ev2.t<ev.t+l) {
							l=ev2.t-ev.t;
							ti=ev2.t;
						}
						else
							ti=ev.t+ev.g;
					}
					else
						ti=ev.t+ev.g;
					mml+=makeNote(n,l,this.timebase);
				}
				return mml;
			},
			hitTest:function(pos){
				var i;
				var ht={t:0,n:0,i:-1,m:" "};
				var l=this.track[this.curtrack].ev.length;
				if(pos.t==this.menu){
					ht.m="m";
					return ht;
				}
				ht.t=(this.xoffset+(pos.x-this.yruler-this.kbwidth)/this.swidth*this.xrange);
				ht.n=this.yoffset-(pos.y-this.height+this.option)/this.steph;
				if(pos.y>=this.height-this.option || pos.x>=this.width){
					return ht;
				}
				if(pos.y<this.xruler){
					ht.m="x";
					return ht;
				}
				if(pos.x<this.yruler+this.kbwidth){
					ht.m="y";
					return ht;
				}
				for(i=0;i<l;++i){
					var ev=this.track[this.curtrack].ev[i];
					if((ht.n|0)==ev.n){
						if(ev.f && Math.abs(ev.t-ht.t)*this.stepw<8){
							ht.m="B";
							ht.i=i;
							return ht;
						}
						if(ev.f && Math.abs(ev.t+ev.g-ht.t)*this.stepw<8){
							ht.m="E";
							ht.i=i;
							return ht;
						}
						if(ht.t>=ev.t&&ht.t<ev.t+ev.g){
							ht.i=i;
							if(this.track[this.curtrack].ev[i].f)
								ht.m="N";
							else
								ht.m="n";
							return ht;
						}
					}
				}
				ht.m="s";
				return ht;
			},
			addNote:function(t,n,g,v,f){
				if(t>=0 && n>=0 && n<128){
					var ev={t:t,c:0x90,n:n,g:g,v:v,f:f};
					this.track[this.curtrack].ev.push(ev);
					this.sortSequence();
					this.redraw();
					return ev;
				}
				return null;
			},
			selAreaNote: function(t1,t2,n1,n2){
				var t,i=0,e=this.track[this.curtrack].ev[i];
				if(n1>n2)
					t=n1,n1=n2,n2=t;
				if(t1>t2)
					t=t1,t1=t2,t2=t;
				while(e){
					if(e.t>=t1 && e.t<t2 && e.n>=n1 && e.n <= n2)
						e.f=1;
					else
						e.f=0;
					e=this.track[this.curtrack].ev[++i];
				}
			},
			delNote:function(idx){
				this.track[this.curtrack].ev.splice(idx,1);
				this.redraw();
			},
			delAreaNote:function(t,g){
				var i;
				var l=this.track[this.curtrack].ev.length;
				for(i=l-1;i>=0;--i){
					var ev=this.track[this.curtrack].ev[i];
					if(!ev.f){
						if(t<=ev.t && t+g>=ev.t+ev.g){
							this.track[this.curtrack].ev.splice(i,1);
						}
						else if(t<=ev.t && t+g>ev.t && t+g<ev.t+ev.g){
							ev.g=ev.t+ev.g-(t+g);
							ev.t=t+g;
						}
						else if(t>=ev.t && t<ev.t+ev.g && t+g>=ev.t+ev.g){
							ev.g=t-ev.t;
						}
						else if(t>ev.t && t+g<ev.t+ev.g){
							this.addNote(t+g,ev.n,ev.t+ev.g-t-g,this.defvelo);
							ev.g=t-ev.t;
						}
					}
				}
			},
			delSelectedNote:function(){
				var i,l=this.track[this.curtrack].ev.length;
				for(i=l-1;i>=0;--i){
					var ev=this.track[this.curtrack].ev[i];
					if(ev.f)
						this.track[this.curtrack].ev.splice(i,1);
				}
			},
			moveSelectedNote:function(dt,dn){
				var ev,i,l=this.track[this.curtrack].ev.length;
				for(i=0;i<l;++i){
					ev=this.track[this.curtrack].ev[i];
					if(ev.f && ev.ot+dt<0)
						dt=-ev.ot;
				}
				for(i=0,l=this.track[this.curtrack].ev.length;i<l;++i){
					var ev=this.track[this.curtrack].ev[i];
					if(ev.f){
						ev.t=(((ev.ot+dt)/this.snap+.5)|0)*this.snap;
						ev.n=ev.on+dn;
					}
				}
			},
			clearSel:function(){
				var i;
				var l=this.track[this.curtrack].ev.length;
				for(i=0;i<l;++i){
					this.track[this.curtrack].ev[i].f=0;
				}
			},
			editDragDown:function(pos){
				var ht=this.hitTest(pos);
				if(ht.m=="N"){
					var ev=this.track[this.curtrack].ev[ht.i];
					this.dragging={o:"D",m:"N",i:ht.i,t:ev.t,n:ev.n,dt:ht.t-ev.t};
					for(var i=0,l=this.track[this.curtrack].ev.length;i<l;++i){
						var ev=this.track[this.curtrack].ev[i];
						if(ev.f)
							ev.on=ev.n, ev.ot=ev.t, ev.og=ev.g;
					}
					this.redraw();
				}
				else if(ht.m=="n"){
					var ev=this.track[this.curtrack].ev[ht.i];
					this.clearSel();
					ev.f=1;
					this.redraw();
				}
				else if(ht.m=="E"){
					this.dragging={o:"D",m:"E",i:ht.i};
				}
				else if(ht.m=="B"){
					this.dragging={o:"D",m:"B",i:ht.i};
				}
				else if(ht.m=="s"&&ht.t>=0){
					this.clearSel();
					var t=((ht.t/this.snap+0.5)|0)*this.snap;
					this.track[this.curtrack].ev.push({t:t, c:0x90, n:ht.n|0, g:1, f:1, v:this.defvelo});
					this.redraw();
					this.dragging={o:"D",m:"E",i:this.track[this.curtrack].ev.length-1};
				}
			},
			editDragMove:function(pos){
				var ht=this.hitTest(pos);
				var ev,t;
				if(this.dragging.o=="D"){
					switch(this.dragging.m){
					case "E":
						ev=this.track[this.curtrack].ev[this.dragging.i];
						t=((Math.max(0,ht.t)/this.snap+0.5)|0)*this.snap;
						ev.g=t-ev.t+1;
						if(ev.g<0){
							ev.t+=ev.g;
							ev.g=-ev.g;
							this.dragging.m="B";
						}
						this.redraw();
						break;
					case "B":
						ev=this.track[this.curtrack].ev[this.dragging.i];
						t=((Math.max(0,ht.t)/this.snap+0.5)|0)*this.snap;
						ev.g=ev.t+ev.g-t;
						ev.t=t;
						if(ev.g<0){
							ev.t+=ev.g;
							ev.g=-ev.g;
							this.dragging.m="E";
						}
						this.redraw();
						break;
					case "N":
						ev=this.track[this.curtrack].ev[this.dragging.i];
						this.moveSelectedNote((ht.t-(this.dragging.t+this.dragging.dt))|0,(ht.n-this.dragging.n)|0);
						this.redraw();
						break;
					}
				}
			},
			editGridDown:function(pos){
				var ht=this.hitTest(pos);
				if(ht.m=="n"){
					this.delNote(ht.i);
					this.dragging={o:"G",m:"0"};
				}
				else if(ht.m=="s"&&ht.t>=0){
					var pt=Math.floor(ht.t);
					if(this.editmode=="gridmono")
						this.delAreaNote(pt,1);
					this.addNote(pt,ht.n|0,1,this.defvelo);
					this.dragging={o:"G",m:"1"};
				}
			},
			editGridMove:function(pos){
				var ht=this.hitTest(pos);
				if(this.dragging.o=="G"){
					switch(this.dragging.m){
					case "1":
						var px=Math.floor(ht.t);
						if(ht.m=="s"){
							if(this.editmode=="gridmono")
								this.delAreaNote(px,1);
							this.addNote(px,ht.n|0,1,this.defvelo);
						}
						break;
					case "0":
						if(ht.m=="n")
							this.delNote(ht.i);
						break;
					}
				}
			},
			loadSmf:function(d){
				var s=new Uint8Array(d);
				var datalen = 0, datastart = 0, runst = 0x90;
				var notetab = [];
//				song.tickmax=0;
				function Get2(s, i) {
					return (s[i]<<8) + s[i+1];
				}
				function Get3(s, i) {
					return (s[i]<<16) + (s[i+1]<<8) + s[i+2];
				}
				function Get4(s, i) {
					return (s[i]<<24) + (s[i+1]<<16) + (s[i+2]<<8) + s[i+3];
				}
				function GetStr(s, i, len) {
					return String.fromCharCode.apply(null,s.slice(i,i+len));
				}
				function Delta(s, i) {
					var v, d;
					v = 0;
					datalen = 1;
					while((d = s[i]) & 0x80) {
						v = (v<<7) + (d&0x7f);
						++datalen;
						++i;
					}
					return (v<<7)+d;
				}
				function Event(proll,tr, ti, s, i) {
					var v = s[i];
					datalen = 1;
					if(ti>tickmax)
						tickmax=ti;
					if((v&0x80) == 0) {
						v = runst;
						datalen = 0;
					}
					runst = v;
					if(tr<0) {
						if(v==0xff)
							tr = 1;
						else
							tr = (v&0xf)+1;
					}
					switch(v&0xf0) {
						case 0x80:
							var note = s[i+datalen];
							for(var i=proll.notetab.length-1; i>=0; --i) {
								var j = proll.notetab[i][0];
								if(proll.notetab[i][0]==tr && proll.notetab[i][2] == note) {
									var e=proll.track[tr].ev[proll.notetab[i][1]];
//									if(e){
										var du = ti - e.t;
										proll.track[tr].ev[proll.notetab[i][1]].g = du;
										proll.notetab.splice(i, 1);
//									}
								}
							}
							datalen+=2;
							break;
						case 0x90:
							var velo = s[i+datalen+1];
							var note = s[i+datalen];
							if(velo>0) {
								if(proll.track[tr].ch<0)
									proll.track[tr].ch=v&0xf;
								proll.notetab.push([tr, proll.track[tr].ev.length, note]);
								var ev={t:ti, g:240, c:0x90, n:note, v:velo, f:0};
								proll.track[tr].ev.push(ev);
							}
							else {
								for(var i=proll.notetab.length-1; i>=0; --i) {
									var j=proll.notetab[i][0];
									if(proll.notetab[i][0]==tr && proll.notetab[i][2] == note) {
										var du=ti-proll.track[j].ev[proll.notetab[i][1]].t;
										proll.track[j].ev[proll.notetab[i][1]].g = du;
										proll.notetab.splice(i, 1);
									}
								}
							}
							datalen += 2;
							break;
						case 0xa0:
							if(proll.track[tr].ch<0)
								proll.track[tr].ch=v&0xf;
							datalen += 2;
							break;
						case 0xb0:
							if(proll.track[tr].ch<0)
								proll.track[tr].ch=v&0xf;
							proll.track[tr].ev.push({t:ti, c:0xb0, n:s[i+datalen], v:s[i+datalen+1]});
							datalen += 2;
							break;
						case 0xc0:
							if(proll.track[tr].ch<0)
								proll.track[tr].ch=v&0xf;
							if(ti==0)
								proll.track[tr].pg = s[i + datalen];
							proll.track[tr].ev.push({t:ti, c:0xc0, v:s[i+datalen]});
							datalen+=1;
							break;
						case 0xd0:
							datalen+=1;
							break;
						case 0xe0:
							var val = s[i+datalen] + (s[i+datalen+1]<<7) - 8192;
							var ev={t:ti, c:0xe0, v:val, f:0};
							proll.track[tr].ev.push(ev);
							datalen+=2;
							break;
						case 0xf0:
							switch(v) {
								case 0xff:
									var len = Delta(s, i + 2);
									datastart = 2+datalen;
									datalen = len+datalen+2;
									switch(s[i+1]) {
										case 0x01:
											if(ti==0) {
												var str = GetStr(s, i+datastart, datalen-3);
												proll.text=str;
											}
											break;
										case 0x02:
											proll.copyright+=GetStr(s, i + datastart, datalen - 3);
											break;
										case 0x03:
											if(tr==1 && ti==0)
												proll.songtitle=proll.track[tr].name=GetStr(s, i + datastart, datalen - 3);
											else
												proll.track[tr].name=GetStr(s, i + datastart, datalen - 3);
											break;
										case 0x04:
											proll.track[tr].name=GetStr(s, i + datastart, datalen - 3);
											break;
										case 0x09:
											var s = GetStr(s, i + datastart, datalen - datastart);
//											console.log(s)
											break;
										case 0x2f:
											return 1;
										case 0x51:
											var val = Math.floor(60000000 / Get3(s, i + 3));
											proll.track[0].ev.push({t:ti, c:0xff51, v:val});
											proll.setTempo(val);
											break;
										case 0x58:
											if(tr==1 && ti==0) {
//												song.nume = s.charCodeAt(i+3);
//												song.denom = Math.pow(2, s.charCodeAt(i+4));
//												song.beat1=1920/song.denom;
//												song.beat=song.beat1*song.nume;
//												document.getElementById("sign").value = song.nume+"/"+song.denom;
											}
											break;
										case 0x59:
											if(tr==1 && ti==0) {
												var m = s[i + 4];
												var n = s[i + 3];
												if (n >= 0x80)
													n -= 256;
												n = (n+7)&0xf;
//												if(m==0)
//													document.getElementById("key").value = ["Cb", "Gb", "Db", "Ab", "Eb", "Bb", "F", "C", "G", "D", "A", "E", "B", "F#", "C#"][n]+" Major";
//												else
//													document.getElementById("key").value = ["Ab", "Eb", "Bb", "F", "C", "G", "D", "A", "E", "B", "F#", "C#", "G#", "D#", "A#"][n]+" Minor";
											}
											break;
									}
									break;
							}
							break;
					}
					return 0;
				}
				var idx = 0;
				var trk;
				var hd = s.slice(0,	4);
				if(hd.toString()!="77,84,104,100"){	//MThd
					return;
				}
				var len = Get4(s, 4);
				var fmt = Get2(s, 8);
				var numtrk = Get2(s, 10);
				var tickmax=0;
				var tb = Get2(s, 12)*4;
//				this.timebase=(tb*4);
				this.setTempo(120);
				console.log("format:"+fmt);
				console.log("numtrk:"+numtrk);
				console.log("timebase:"+tb);
				idx = (len + 8);
				if(fmt==0) {
					this.track=[];
					for(var i=0;i<17;++i)
						this.track.push({name:"Tempo",ev:[],ch:-1,pg:i});
				}
				else {
					this.track=[];
					for(var i=0;i<=numtrk;++i)
						this.track.push({name:"",ev:[],ch:-1,pg:i});
				}
				this.songtitle="";
				this.copyright="";
				this.text="";
				this.notetab=[];
//				song.markstart = song.markend = -1;
				for(trk=1; trk<=numtrk; ++trk) {
					hd=s.slice(idx, idx+4);
					len=Get4(s, idx+4);
					if(hd.toString()=="77,84,114,107") {//MTrk
						var tick = 0;
						var j = 0;
						this.notetab.length = 0;
						for(;;) {
							tick += Delta(s, idx + 8 + j);
							j += datalen;
							var e;
							if(fmt==0)
								e = Event(this,-1, Math.floor(tick / tb * this.timebase), s, idx + 8 + j);
							else
								e = Event(this,trk, Math.floor(tick / tb * this.timebase), s, idx + 8 + j);
							j += datalen;
							if(e)
								break;
						}
						tick=Math.floor(tick / tb * this.timebase);
						if(tick>tickmax)
							tickmax=tick;
					}
					idx += (len+8);
//					this.sortSequence(tr-1);
				}
//				console.log(tickmax)
				this.markend=tickmax;
				this.redraw();
				this.fire("songload");
				return;
				for(var i=song.track[this.curtrack].ev.length-1;i>0;--i) {
					if(song.track[this.curtrack][i].ev.length==0) {
						song.track[this.curtrack].splice(i, 1);
						song.numtrk--;
					}
				}
				if(fmt>0) {
					if(song.track[this.curtrack].length>17) {
						aleart("Number of track = ["+(song.track[this.curtrack].length-1)+"]\nIgnored over 16th track.");
						for(var i=song.track[this.curtrack].length-1;i>16;--i) {
							song.track[this.curtrack].splice(i, 1);
							song.numtrk--;
						}
					}
					for(var i=0; i<song.track.length; ++i) {
						song.track[i].tr=i;
						if(song.track[i].ch < 0)
							song.track[i].ch = 0;
					}

				}
				if(song.track[0].ev.length==0 || song.track[0].ev[0][0]!=0) {
					song.track[0].ev.unshift([0, 0, 0xff51, 120, 0, 0]);
					song.track[0].Sort();
				}
				var lastti=-1;
				for(var i=song.track[0].ev.length-1;i>=0;--i) {
					var ev=song.track[0].ev[i];
					if(ev[0]==lastti)
						song.track[0].ev.splice(i,1);
					lastti=ev[0];
				}
				for(var j=1;j<song.numtrk;++j) {
					var lasttic0=-1;
					var lasttie0=-1;
					var lasttib01=-1;
					var lasttib07=-1;
					var lasttib010=-1;
					for(var i=song.track[j].ev.length-1;i>=0;--i) {
						var ev=song.track[j].ev[i];
						if(ev[2]==0xb0) {
							if(ev[3]==1) {
								if(ev[0]==lasttib01)
									song.track[j].ev.splice(i,1);
								lasttib01=ev[0];
							}
							if(ev[3]==7) {
								if(ev[0]==lasttib07)
									song.track[j].ev.splice(i,1);
								lasttib07=ev[0];
							}
							if(ev[3]==10) {
								if(ev[0]==lasttib010)
									song.track[j].ev.splice(i,1);
								lasttib010=ev[0];
							}
						}
						if(ev[2]==0xc0) {
							if(ev[0]==lasttic0)
								song.track[j].ev.splice(i,1);
							lasttic0=ev[0];
						}
						if(ev[2]==0xe0) {
							if(ev[0]==lasttie0)
								song.track[j].ev.splice(i,1);
							lasttie0=ev[0];
						}
					}
				}
				song.inibpm=song.bpm=song.track[0].ev[0][3];
				if(song.markstart<0)
					song.markstart = 0;
				if(song.markend<0)
					song.markend = Math.floor(song.tickmax);
				if(song.numtrk>1)
					SelTrk(1);
				song.Draw();
				proll.Draw();
				for(var i=0; i<4; ++i) {
					if(synths.patch[i]=="")
						synths.patchready[i] = true;
					else
						synths.patchready[i] = false;
				}
				setuptimerid = setInterval(SetupPreset,500);
			},
			setListener:function(el,mode){
				el.addEventListener("mousedown",this.pointerdown.bind(this),false);
				el.addEventListener("mousemove",this.pointermove.bind(this),false);
				el.addEventListener("mouseup",this.cancel.bind(this),false);
				el.addEventListener("touchstart",this.pointerdown.bind(this),false);
				el.addEventListener("contextmenu",this.contextmenu.bind(this),false);
				el.addEventListener('DOMMouseScroll',this.wheel.bind(this),false);
				el.addEventListener('mousewheel',this.wheel.bind(this),false);
				if(mode){
					el.addEventListener("mouseover",this.pointerover.bind(this),false);
					el.addEventListener("mouseout",this.pointerout.bind(this),false);
				}
			},
			dragOver:function(e){
				e.stopPropagation();
				e.preventDefault();
				e.dataTransfer.dropEffect = "copy";
			},
			drop:function(e){
				var f = e.dataTransfer.files;
				var reader = new FileReader();
				reader.onload=(e)=>{
					this.loadSmf(reader.result);
					this.sortSequence();
				}
				reader.readAsArrayBuffer(f[0]);
				e.stopPropagation();
				e.preventDefault();
			},
			ready:function(){
				var body = this.$['wac-body'];
				this.canvas = this.$['wac-pianoroll'];
				this.canvas.addEventListener('keydown',this.keydown.bind(this),false);
				this.canvas.addEventListener('DOMMouseScroll',this.wheel.bind(this),false);
				this.canvas.addEventListener('mousewheel',this.wheel.bind(this),false);
				this.canvas.addEventListener('dragover',this.dragOver.bind(this),false);
				this.canvas.addEventListener('drop',this.drop.bind(this),false);
				this.setListener(this.canvas,true);
				this.ctx=this.$['wac-pianoroll'].getContext("2d");
				this.cursorimg=this.$['wac-cursor'];
				this.markstartimg=this.$['wac-markstart'];
				this.markendimg=this.$['wac-markend'];
				this.menu=this.$['wac-menu'];
				this.setListener(this.markendimg,true);
				this.setListener(this.markstartimg,true);
				this.setListener(this.cursorimg,true);
				this.setListener(this.menu,false);
				this.kbimg=this.$['wac-kb'];
				this.track=[{name:"",ev:[],ch:0}];
				this.curtrack=0;
				this.dragging={o:null};
				this.kbimg.style.height=(this.sheight-this.option)+"px";
				this.kbimg.style.backgroundSize=(this.steph*12)+"px";
				this.layout();
				this.initialized=1;
				this.redraw();
			},
			setupImage: function(){
				var body = this.$['wac-body'];
				var knb = this.$['wac-pianoroll'];
			},
			preventScroll: function(e){
				e.preventDefault();
			},
			getPos: function(e){
				return {
					t:e.target,
					x:e.clientX-this.rcTarget.left,
					y:e.clientY-this.rcTarget.top,
				};
			},
			contextmenu: function(e){
				e.preventDefault();
				return false;
				var pos=this.getPos(e);
				var ht=this.hitTest(pos);
				switch(ht.m){
				case "N":
				case "E":
				case "B":
					this.delSelectedNote();
					break;
				}
				this.redraw();
				e.preventDefault();
			},
			keydown: function(e){
				switch(e.keyCode){
				case 46://delNote
					this.delSelectedNote();
					this.redraw();
					break;
				}
			},
			popMenu: function(pos){
				var s=this.menu.style;
				s.top=(pos.y+8)+"px";
				s.left=(pos.x+8)+"px";
				s.background="#eef";
				s.display="block";
			},
			pointerdown: function(e) {
				if(!this.enable)
					return;
				if(e.touches)
					e = e.touches[0];
				this.rcTarget=this.canvas.getBoundingClientRect();
				this.boundPointermove = this.pointermove.bind(this);
				this.boundCancel = this.cancel.bind(this);
//				window.addEventListener('touchmove', this.boundPointermove, true);
//				window.addEventListener('mouseup', this.boundCancel, true);
//				window.addEventListener('touchend', this.boundCancel, true);
//				window.addEventListener('touchcancel', this.boundCancel, true);
				document.body.addEventListener('touchstart',this.preventScroll);
				var pos=this.getPos(e);
				var ht=this.hitTest(pos);
				if(e.button==2){
					switch(ht.m){
					case "N":
					case "B":
					case "E":
						this.popMenu(pos);
						this.dragging={o:"m"};

//						this.dragging={o:"A",p:pos,p2:pos,t1:ht.t,n1:ht.n};
						break;
					default:
						this.dragging={o:"A",p:pos,p2:pos,t1:ht.t,n1:ht.n};
						break;
					}
					e.preventDefault();
					e.stopPropagation();
					this.canvas.focus();
					return false;
				}
				switch(e.target){
				case this.markendimg:
					this.dragging={o:"E",x:pos.x,m:this.markend};
					e.preventDefault();
					e.stopPropagation();
					return false;
				case this.markstartimg:
					this.dragging={o:"S",x:pos.x,m:this.markstart};
					e.preventDefault();
					e.stopPropagation();
					return false;
				case this.cursorimg:
					this.dragging={o:"P",x:pos.x,m:this.cursor};
					e.preventDefault();
					e.stopPropagation();
					return false;
				}
				this.canvas.focus();
				switch(this.editmode){
				case "gridpoly":
				case "gridmono":
					this.editGridDown(pos);
					break;
				case "dragpoly":
				case "dragmono":
					this.editDragDown(pos);
					break;
				}
				this.press = 1;
				e.preventDefault();
				e.stopPropagation();
				return false;
			},
			pointermove: function(e) {
				this.rcTarget=this.canvas.getBoundingClientRect();
				if(e.touches)
					e = e.touches[0];
				var pos=this.getPos(e);
				var ht=this.hitTest(pos);
				switch(this.dragging.o){
				case null:
					switch(ht.m){
					case "E": this.canvas.style.cursor="e-resize"; break;
					case "B": this.canvas.style.cursor="w-resize"; break;
					case "N": this.canvas.style.cursor="move"; break;
					case "n": this.canvas.style.cursor="pointer"; break;
					case "s": this.canvas.style.cursor="pointer"; break;
					}
					break;
				case "m":
					if(ht.m=="m"){
						this.menu.style.background="#ff6";
					}
					else {
						this.menu.style.background="#eef";
					}
					break;
				case "A":
					this.dragging.p2=pos;
					this.dragging.t2=ht.t;
					this.dragging.n2=ht.n;
					this.redraw();
					break;
				case "E":
					var p=Math.max(1,(this.dragging.m+(pos.x-this.dragging.x)/this.stepw+.5)|0);
					if(this.markstart>=p)
						this.markstart=p-1;
					this.markend=p;
					break;
				case "S":
					var p=Math.max(0,(this.dragging.m+(pos.x-this.dragging.x)/this.stepw+.5)|0);
					if(this.markend<=p)
						this.markend=p+1;
					this.markstart=p;
					break;
				case "P":
					this.cursor=Math.max(0,(this.dragging.m+(pos.x-this.dragging.x)/this.stepw+.5)|0);
					break;
				}
				switch(this.editmode){
				case "gridpoly":
				case "gridmono":
					this.editGridMove(pos);
					break;
				case "dragpoly":
				case "dragmono":
					this.editDragMove(pos);
					break;
				}
				e.preventDefault();
				e.stopPropagation();
				return false;
			},
			cancel: function(e) {
				var pos=this.getPos(e);
				var ht=this.hitTest(pos);
				if(this.dragging.o=="m"){
					this.menu.style.display="none";
					if(ht.m=="m"){
						this.delSelectedNote();
						this.redraw();
					}
				}
				if(this.dragging.o=="A"){
					this.selAreaNote(this.dragging.t1,this.dragging.t2,this.dragging.n1,this.dragging.n2);
					this.dragging={o:null};
					this.redraw();
				}
				if(this.dragging.o=="D"){
					var ev=this.track[this.curtrack].ev[this.dragging.i];
					if(this.editmode=="dragmono")
						this.delAreaNote(ev.t,ev.g);
					this.redraw();
				}
				this.dragging={o:null};
				if(this.press){
					this.sortSequence();
				}
				this.press = 0;
//				window.removeEventListener('touchmove', this.boundPointermove, true);
//				window.removeEventListener('mouseup', this.boundCancel, true);
//				window.removeEventListener('touchend', this.boundCancel, true);
//				window.removeEventListener('touchcancel', this.boundCancel, true);
				document.body.removeEventListener('touchstart',this.preventScroll,false);
				e.preventDefault();
				e.stopPropagation();
				return false;
			},
			pointerover: function(e) {
			},
			pointerout: function(e) {
			},
			wheel: function(e) {
				var delta = 0;
				var pos=this.getPos(e);
				var ht=this.hitTest(pos);
				if(!e)
					e = window.event;
				if(e.wheelDelta)
					delta = e.wheelDelta/120;
				else if(e.detail)
					delta = -e.detail/3;
				if(ht.m!="y" && this.wheelzoom&1){
					if(delta>0){
						this.xoffset=ht.t-(ht.t-this.xoffset)/1.2
						this.xrange/=1.2;
					}
					else{
						if(this.xrange<this.timebase*50){
							this.xoffset=ht.t-(ht.t-this.xoffset)*1.2
							this.xrange*=1.2;
						}
					}
				}
				if(ht.m!="x" && this.wheelzoom&2){
					if(delta>0){
						this.yoffset=ht.n-(ht.n-this.yoffset)/1.2;
						this.yrange/=1.2;
					}
					else{
						this.yoffset=ht.n-(ht.n-this.yoffset)*1.2
						this.yrange*=1.2;
					}
				}
				e.preventDefault();
			},
			setTempo: function(t){
				this.tempo=t;
				this.tick2time=4*60/this.tempo/this.timebase;
			},
			layout: function(){
				if(typeof(this.kbwidth)=="undefined")
					return;
				var proll = this.$['wac-pianoroll'];
				var bodystyle = this.$['wac-body'].style;
				proll.style.background="url('"+this.bgsrc+"')";
				this.$['wac-kb'].style.background="url('"+this.kbsrc+"')";

				if(this.width){
					proll.width = this.width;
					bodystyle.width = proll.style.width = this.width+"px";
				}
				if(this.height) {
					proll.height = this.height;
					bodystyle.height = proll.style.height = this.height+"px";
				}
				this.swidth=proll.width-this.yruler;
				this.swidth-=this.kbwidth;
				this.sheight=proll.height-this.xruler-this.option;
				this.redraw();
			},
			redrawMarker: function(){
				if(!this.initialized)
					return;
				var cur=(this.cursor-this.xoffset)*this.stepw+this.yruler+this.kbwidth;
				this.cursorimg.style.left=(cur+this.cursoroffset)+"px";
				var start=(this.markstart-this.xoffset)*this.stepw+this.yruler+this.kbwidth;
				this.markstartimg.style.left=(start+this.markstartoffset)+"px";
				var end=(this.markend-this.xoffset)*this.stepw+this.yruler+this.kbwidth;
				this.markendimg.style.left=(end+this.markendoffset)+"px";
			},
			redrawGrid: function(){
				this.ctx.fillStyle=this.collt;
				this.ctx.fillRect(this.yruler+this.kbwidth, this.xruler, this.swidth,this.sheight);
					for(y=0;y<128;++y){
						var ys = this.height - this.option - (y - this.yoffset) * this.steph;
						if((this.semiflag[y%12]&1)&&this.steph>=1){
							this.ctx.fillStyle=this.coldk;
							this.ctx.fillRect(this.yruler+this.kbwidth, ys|0, this.swidth,-this.steph);
						}
						if(this.steph>=8){
							this.ctx.fillStyle=this.colgrid;
							this.ctx.fillRect(this.yruler+this.kbwidth, ys|0, this.swidth,1);
						}
					}
				this.ctx.fillStyle=this.colgrid;
				var g=this.grid.split(",");
				for(var j=0,l=g.length;j<l;++j){
					var w=g[j]*this.stepw;
					if(w>=8){
						w=parseFloat(g[j]);
						for(t=0;;t+=w){
							x=this.stepw*(t-this.xoffset)+this.yruler+this.kbwidth;
							this.ctx.fillRect(x|0,this.xruler,1,this.sheight);
							if(x>=this.width)
								break;
						}
					}
				}
			},
			redrawOption:function(){
				var l,s,ev,x,y;
				if(this.option<=0)
					return;
				this.ctx.fillStyle=this.collt;
				this.ctx.fillRect(this.yruler,this.sheight+this.yruler,this.width,this.option);
				l=this.track[this.curtrack].ev.length;
				for(s=0; s<l; ++s){
					ev=this.track[this.curtrack].ev[s];
					if((ev.c&0xf0)==0x90){
						if(ev.f)
							this.ctx.fillStyle=this.colnotesel;
						else
							this.ctx.fillStyle=this.colnote;
						x=(ev.t-this.xoffset)*this.stepw+this.yruler+this.kbwidth;
						y=ev.v*this.option/128;
						this.ctx.fillRect(x,this.height,2,-y);
						if(ev.f)
							this.ctx.fillStyle=this.colnoteselborder;
						else
							this.ctx.fillStyle=this.colnoteborder;
	//					this.ctx.fillRect(x,this.height,1,-y);
	//					this.ctx.fillRect(x+2,this.height,1,-y);
	//					this.ctx.fillRect(x,this.height-y,2,1);
					}
				}
				this.ctx.fillStyle=this.colgrid;
				this.ctx.fillRect(this.yruler,this.sheight+this.yruler,this.width,1);
				this.ctx.fillRect(this.yruler,this.height-1,this.width,1);
			},
			semiflag:[6,1,0,1,0,2,1,0,1,0,1,0],
			redrawXRuler: function(){
				if(this.xruler){
					this.ctx.textAlign="left";
					this.ctx.font=(this.xruler/2)+"px 'sans-serif'";
					this.ctx.fillStyle=this.colrulerbg;
					this.ctx.fillRect(0,0,this.width,this.xruler);
					this.ctx.fillStyle=this.colrulerborder;
					this.ctx.fillRect(0,0,this.width,1);
					this.ctx.fillRect(0,0,1,this.xruler);
					this.ctx.fillRect(0,this.xruler-1,this.width,1);
					this.ctx.fillRect(this.width-1,0,1,this.xruler);
					this.ctx.fillStyle=this.colrulerfg;
					var nw=1,bw=this.timebase*this.stepw;
					while(bw<32)
						bw<<=1,nw<<=1;
					for(t=0;;t+=this.timebase){
						var n=t/this.timebase+1;
						x=(t-this.xoffset)*this.stepw+this.yruler+this.kbwidth;
						this.ctx.fillRect(x,0,1,this.xruler);
						if((n-1)%nw==0)
							this.ctx.fillText(n,x+4,this.xruler-8);
						if(x>=this.width)
							break;
					}
				}
			},
			redrawYRuler: function(){
				if(this.yruler){
					this.ctx.textAlign="right";
					this.ctx.font=(this.steph/2)+"px 'sans-serif'";
					this.ctx.fillStyle=this.colrulerbg;
					this.ctx.fillRect(0,this.xruler,this.yruler,this.sheight+this.option);
					this.ctx.fillStyle=this.colrulerborder;
					this.ctx.fillRect(0,this.xruler,1,this.sheight+this.option);
					this.ctx.fillRect(this.yruler,this.xruler,1,this.sheight+this.option);
					this.ctx.fillRect(0,this.height-this.option -1,this.yruler,1);
					this.ctx.fillStyle=this.colrulerfg;
					for(var y=0;y<128;y+=12){
						var ys=this.height-this.option-this.steph*(y-this.yoffset);
						this.ctx.fillRect(0,ys|0,this.yruler,-1);
						this.ctx.fillText("C"+(((y/12)|0)+this.octadj),this.yruler-4,ys-4);
					}
				}
				this.kbimg.style.top=(this.xruler)+"px";
				this.kbimg.style.left=this.yruler+"px";
				this.kbimg.style.width=this.kbwidth+"px";
				this.kbimg.style.height=this.sheight+"px";
				this.kbimg.style.backgroundSize="100% "+(this.steph*12)+"px";
				this.kbimg.style.backgroundPosition="0px "+(this.sheight+this.steph*this.yoffset)+"px";
			},
			redrawAreaSel:function(){
				if(this.dragging && this.dragging.o=="A"){
					this.ctx.fillStyle=this.colselarea;
					this.ctx.fillRect(this.dragging.p.x,this.dragging.p.y,this.dragging.p2.x-this.dragging.p.x,this.dragging.p2.y-this.dragging.p.y);
				}
			},
			redraw: function() {
				var s,t,x,w,y,x2,y2;
				if(!this.ctx)
					return;
				var style = this.$['wac-pianoroll'].style;
				this.ctx.clearRect(0,0,this.width,this.height);
				this.stepw = this.swidth/this.xrange;
				this.steph = this.sheight/this.yrange;
				this.redrawGrid();
				var l=this.track[this.curtrack].ev.length;
				for(s=0; s<l; ++s){
					var ev=this.track[this.curtrack].ev[s];
					if((ev.c&0xf0)==0x90){
						if(ev.f)
							this.ctx.fillStyle=this.colnotesel;
						else
							this.ctx.fillStyle=this.colnote;
						w=ev.g*this.stepw;
						x=(ev.t-this.xoffset)*this.stepw+this.yruler+this.kbwidth;
						x2=(x+w)|0; x|=0;
						y=this.height - this.option - (ev.n-this.yoffset)*this.steph;
						y2=(y-this.steph)|0; y|=0;
						this.ctx.fillRect(x,y,x2-x,y2-y);
						if(ev.f)
							this.ctx.fillStyle=this.colnoteselborder;
						else
							this.ctx.fillStyle=this.colnoteborder;
						this.ctx.fillRect(x,y,1,y2-y);
						this.ctx.fillRect(x2,y,1,y2-y);
						this.ctx.fillRect(x,y,x2-x,1);
						this.ctx.fillRect(x,y2,x2-x,1);
					}
				}
				this.redrawYRuler();
				this.redrawXRuler();
				this.redrawMarker();
				this.redrawOption();
				this.redrawAreaSel();
			}
	});
	</script>
</dom-module>
